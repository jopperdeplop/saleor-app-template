{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/shopify-inventory.ts"],
  "sourcesContent": ["import { schedules, task, tasks, logger } from \"@trigger.dev/sdk\";\r\nimport { db } from \"../db\";\r\nimport { integrations } from \"../db/schema\";\r\nimport { eq } from \"drizzle-orm\";\r\n\r\nconst DEFAULT_WAREHOUSE_ID = process.env.SALEOR_WAREHOUSE_ID;\r\n\r\n// Helper: Addressing for Warehouse\r\nconst DEFAULT_VENDOR_ADDRESS = {\r\n    firstName: \"Logistics\",\r\n    lastName: \"Manager\",\r\n    companyName: \"Vendor Warehouse\",\r\n    streetAddress1: \"123 Market St\",\r\n    city: \"San Francisco\",\r\n    postalCode: \"94105\",\r\n    country: \"US\",\r\n    countryArea: \"CA\"\r\n};\r\n\r\n/**\r\n * PARENT TASK: Runs every 6 hours and triggers a sync for every active store.\r\n */\r\nexport const shopifyInventoryScheduledSync = schedules.task({\r\n    id: \"shopify-inventory-scheduled-sync\",\r\n    cron: \"0 */6 * * *\", // Every 6 hours\r\n    run: async (payload) => {\r\n        const activeIntegrations = await db.query.integrations.findMany({\r\n            where: eq(integrations.status, \"active\")\r\n        });\r\n\r\n        const shopifyStores = activeIntegrations.filter(i => i.provider === \"shopify\");\r\n        logger.info(`â° Scheduled Shopify Sync: Found ${shopifyStores.length} stores.`);\r\n\r\n        for (const integration of shopifyStores) {\r\n            await shopifyInventorySync.trigger({ integrationId: integration.id });\r\n        }\r\n    }\r\n});\r\n\r\n/**\r\n * CHILD TASK: Syncs inventory for a specific Shopify store.\r\n */\r\nexport const shopifyInventorySync = task({\r\n    id: \"shopify-inventory-sync\",\r\n    run: async (payload: { integrationId: number, since?: string }) => {\r\n        logger.info(`ðŸ” Received Sync Request for Integration ID: ${payload.integrationId}`);\r\n\r\n        const integration = await db.query.integrations.findFirst({\r\n            where: eq(integrations.id, payload.integrationId)\r\n        });\r\n\r\n        if (!integration || integration.provider !== \"shopify\") {\r\n            logger.error(`âŒ Integration ${payload.integrationId} not found or not Shopify.`);\r\n            return;\r\n        }\r\n\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        // --- ðŸ©º TOKEN VERIFICATION (MASKED) ---\r\n        if (saleorToken) {\r\n            const start = saleorToken.substring(0, 5);\r\n            const end = saleorToken.substring(saleorToken.length - 5);\r\n            logger.info(`ðŸ”‘ [SECURITY] Using Saleor Token: ${start}...${end} (Length: ${saleorToken.length})`);\r\n            saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n        }\r\n\r\n        if (!apiUrl || !saleorToken) throw new Error(\"Missing SALEOR_API_URL or SALEOR_TOKEN\");\r\n\r\n        const saleorHeaders = {\r\n            'Authorization': saleorToken,\r\n            'Content-Type': 'application/json'\r\n        };\r\n\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            try {\r\n                const res = await fetch(apiUrl, {\r\n                    method: 'POST',\r\n                    headers: saleorHeaders,\r\n                    body: JSON.stringify({ query, variables })\r\n                });\r\n                const json: any = await res.json();\r\n                if (json.errors) {\r\n                    const isSchemaError = json.errors[0]?.message?.includes(\"Cannot query field\");\r\n                    if (isSchemaError) logger.error(\"   âŒ Saleor Schema Error:\", { message: json.errors[0].message });\r\n                    else logger.error(\"   âŒ Saleor Error:\", { errors: json.errors });\r\n                }\r\n                return json;\r\n            } catch (e) {\r\n                logger.error(\"   âŒ Network Error during Saleor Request:\", { error: e instanceof Error ? e.message : e });\r\n                return {};\r\n            }\r\n        };\r\n\r\n        // 1. Fetch Shopify Inventory\r\n        const baseFilter = \"status:active AND inventory_total:>0\";\r\n        const filter = payload.since ? `${baseFilter} AND updated_at:>=${payload.since}` : baseFilter;\r\n\r\n        const shopifyQuery = `{ products(first:50, query: \"${filter}\") { edges { node { id title vendor variants(first:50){edges{node{id title sku inventoryQuantity}}} } } } }`;\r\n\r\n        logger.info(`ðŸ“¡ Connecting to Shopify for ${integration.storeUrl}...`);\r\n\r\n        const shopifyRes = await fetch(`https://${integration.storeUrl}/admin/api/2024-04/graphql.json`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'X-Shopify-Access-Token': integration.accessToken || \"\"\r\n            },\r\n            body: JSON.stringify({ query: shopifyQuery })\r\n        });\r\n        const shopifyJson = await shopifyRes.json();\r\n        const products = shopifyJson.data?.products?.edges || [];\r\n\r\n        if (products.length === 0) {\r\n            logger.info(payload.since ? `âœ¨ No recent changes found since ${payload.since}.` : \"Empty Shopify catalog or no active stock found.\");\r\n            return;\r\n        }\r\n\r\n        // 2. Setup Saleor Context (Channels/Warehouses)\r\n        const channelsRes = await saleorFetch(`{ channels { id slug } }`);\r\n        const channels = channelsRes.data?.channels || [];\r\n\r\n        const getWarehouseId = async (vendorName: string) => {\r\n            const slug = `vendor-${vendorName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;\r\n            const find = await saleorFetch(`query Find($s:String!){warehouses(filter:{search:$s},first:5){edges{node{id name slug}}}}`, { s: vendorName });\r\n\r\n            const existing = find.data?.warehouses?.edges?.find((e: any) => e.node.slug === slug || e.node.name === `${vendorName} Warehouse`)?.node;\r\n            if (existing) return existing.id;\r\n\r\n            logger.info(`ðŸ­ Creating Warehouse: \"${vendorName}\"`);\r\n            const inputs = {\r\n                name: `${vendorName} Warehouse`,\r\n                slug: slug,\r\n                address: DEFAULT_VENDOR_ADDRESS,\r\n                email: \"vendor@example.com\"\r\n            };\r\n\r\n            const createRes = await saleorFetch(`mutation CreateWarehouse($input:WarehouseCreateInput!){createWarehouse(input:$input){warehouse{id} errors{field message}}}`, {\r\n                input: inputs\r\n            });\r\n\r\n            const result = createRes.data?.createWarehouse;\r\n            const newId = result?.warehouse?.id;\r\n\r\n            if (newId) {\r\n                logger.info(`   âœ… Warehouse Created: ${newId}`);\r\n                // Link to channels\r\n                for (const ch of channels) {\r\n                    await saleorFetch(`mutation UpdCh($id:ID!,$input:ChannelUpdateInput!){channelUpdate(id:$id,input:$input){errors{field}}}`, { id: ch.id, input: { addWarehouses: [newId] } });\r\n                }\r\n                return newId;\r\n            }\r\n\r\n            logger.warn(`   âŒ Warehouse Creation failed. Falling back to: ${DEFAULT_WAREHOUSE_ID}`);\r\n            return DEFAULT_WAREHOUSE_ID;\r\n        };\r\n\r\n        // --- 3. DEDUPLICATED CONTEXT SETUP ---\r\n        const uniqueVendors: string[] = Array.from(new Set(products.map((p: any) => (p.node.vendor || \"Default\") as string)));\r\n        const warehouseContext = new Map<string, string>();\r\n\r\n        logger.info(`ðŸ—ï¸  Resolving warehouses for ${uniqueVendors.length} vendors...`);\r\n        for (const vendor of uniqueVendors) {\r\n            const whId = await getWarehouseId(vendor);\r\n            if (whId) warehouseContext.set(vendor, whId);\r\n        }\r\n\r\n        // --- 4. Process Inventory Updates ---\r\n        logger.info(`ðŸ”„ Deterministic Sync for ${products.length} products...`);\r\n\r\n        for (const pEdge of products as any[]) {\r\n            const sp = pEdge.node;\r\n            if (!sp || !sp.title) continue;\r\n\r\n            const vendorName = (sp.vendor || \"Default\") as string;\r\n            const warehouseId = warehouseContext.get(vendorName);\r\n            if (!warehouseId) continue;\r\n\r\n            const cleanTitle = sp.title.trim();\r\n            const predictableSlug = cleanTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');\r\n\r\n            let saleorProd: any = null;\r\n            const slugRes = await saleorFetch(`query FindSlug($s:String!){product(slug:$s){id name variants{id name sku}}}`, { s: predictableSlug });\r\n            saleorProd = slugRes.data?.product;\r\n\r\n            if (!saleorProd) {\r\n                const searchRes = await saleorFetch(`query FindProd($n:String!){products(filter:{search:$n},first:20){edges{node{id name variants{id name sku}}}}}`, { n: cleanTitle });\r\n                saleorProd = searchRes.data?.products?.edges?.find((e: any) => e.node.name?.trim() === cleanTitle)?.node;\r\n            }\r\n\r\n            if (!saleorProd) continue;\r\n\r\n            // Sync Variants\r\n            const variants = sp.variants?.edges || [];\r\n            for (const vEdge of variants) {\r\n                const sv = vEdge.node;\r\n                const shopifyId = sv.id ? sv.id.split('/').pop() : null;\r\n                if (!shopifyId) continue;\r\n\r\n                const saleorVar = saleorProd.variants?.find((ev: any) => ev.sku === shopifyId);\r\n                if (saleorVar) {\r\n                    const upRes = await saleorFetch(`mutation UpdStock($id:ID!,$stocks:[StockInput!]!){productVariantStocksUpdate(variantId:$id,stocks:$stocks){errors{field message}}}`, {\r\n                        id: saleorVar.id,\r\n                        stocks: [{ warehouse: warehouseId, quantity: sv.inventoryQuantity || 0 }]\r\n                    });\r\n                    if (!upRes.data?.productVariantStocksUpdate?.errors?.length) {\r\n                        logger.info(`      âœ… Stock Updated: \"${cleanTitle}\" - SKU ${shopifyId} -> ${sv.inventoryQuantity}`);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        logger.info(`âœ… Inventory Sync Complete for ${integration.storeUrl}`);\r\n    }\r\n});\r\n"],
  "mappings": "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",
  "names": []
}
