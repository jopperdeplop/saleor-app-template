{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/woocommerce-inventory.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { db } from \"../db\";\r\nimport { integrations } from \"../db/schema\";\r\nimport { eq } from \"drizzle-orm\";\r\nimport { decrypt } from \"../lib/encryption\";\r\n\r\nexport const woocommerceInventorySync = task({\r\n    id: \"woocommerce-inventory-sync\",\r\n    run: async (payload: { integrationId: number, wcProductId: number, stockStatus: string, stockQuantity?: number, manageStock: boolean }) => {\r\n        const { integrationId, wcProductId, stockStatus, stockQuantity, manageStock } = payload;\r\n\r\n        // 1. Setup & Auth\r\n        const integration = await db.query.integrations.findFirst({ where: eq(integrations.id, integrationId) });\r\n        if (!integration) throw new Error(\"Integration not found\");\r\n\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n        if (saleorToken) saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n\r\n        const saleorHeaders = { 'Authorization': saleorToken, 'Content-Type': 'application/json' };\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            const res = await fetch(apiUrl!, { method: 'POST', headers: saleorHeaders, body: JSON.stringify({ query, variables }) });\r\n            return await res.json();\r\n        };\r\n\r\n        const WAREHOUSE_ID = process.env.SALEOR_WAREHOUSE_ID;\r\n        if (!WAREHOUSE_ID) throw new Error(\"Missing SALEOR_WAREHOUSE_ID\");\r\n\r\n        // 2. Map WC Stock to Saleor Quantity\r\n        let quantity = 0;\r\n        if (manageStock) {\r\n            quantity = stockQuantity || 0;\r\n        } else {\r\n            quantity = stockStatus === 'instock' ? 100 : 0;\r\n        }\r\n\r\n        // 3. Find Vendor Warehouse\r\n        const vendor = new URL(integration.storeUrl).hostname;\r\n        const whSlug = `vendor-${vendor.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;\r\n        const whRes = await saleorFetch(`query FindWH($s:String!){warehouses(filter:{search:$s},first:1){edges{node{id slug}}}}`, { s: vendor });\r\n        let targetWarehouseId = whRes.data?.warehouses?.edges?.find((e: any) => e.node.slug === whSlug)?.node?.id || process.env.SALEOR_WAREHOUSE_ID;\r\n\r\n        if (!targetWarehouseId) throw new Error(\"No target warehouse found for sync.\");\r\n\r\n        // 4. Find Saleor Variant by External Reference\r\n        const findVarRes = await saleorFetch(`\r\n            query FindVar($ref: String!) {\r\n                productVariants(filter: { externalReference: $ref }, first: 10) {\r\n                    edges {\r\n                        node {\r\n                            id\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        `, { ref: wcProductId.toString() });\r\n\r\n        const variants = findVarRes.data?.productVariants?.edges || [];\r\n        if (variants.length === 0) {\r\n            console.warn(`âš ï¸ No Saleor variant found for WooCommerce Product ID: ${wcProductId}`);\r\n            return;\r\n        }\r\n\r\n        // 5. Update Stock for all matching variants\r\n        for (const edge of variants) {\r\n            const variantId = edge.node.id;\r\n            console.log(`ðŸ“¦ Updating Saleor Stock for Variant ${variantId} -> Quantity: ${quantity} in Warehouse: ${targetWarehouseId}`);\r\n\r\n            await saleorFetch(`\r\n                mutation UpdateStock($id: ID!, $stocks: [StockInput!]!) {\r\n                    productVariantUpdate(id: $id, input: { stocks: $stocks }) {\r\n                        errors { field message }\r\n                    }\r\n                }\r\n            `, {\r\n                id: variantId,\r\n                stocks: [{ warehouse: targetWarehouseId, quantity: quantity }]\r\n            });\r\n        }\r\n\r\n        console.log(`âœ… Inventory sync completed for WC Product ${wcProductId}`);\r\n    }\r\n});\r\n"],
  "mappings": ";;;;;;;;;;;;;;;AAAA;AAMO,IAAM,2BAA2B,KAAK;AAAA,EACzC,IAAI;AAAA,EACJ,KAAK,8BAAO,YAA+H;AACvI,UAAM,EAAE,eAAe,aAAa,aAAa,eAAe,YAAY,IAAI;AAGhF,UAAM,cAAc,MAAM,GAAG,MAAM,aAAa,UAAU,EAAE,OAAO,GAAG,aAAa,IAAI,aAAa,EAAE,CAAC;AACvG,QAAI,CAAC,YAAa,OAAM,IAAI,MAAM,uBAAuB;AAEzD,UAAM,SAAS,QAAQ,IAAI;AAC3B,QAAI,eAAe,QAAQ,IAAI,oBAAoB,QAAQ,IAAI,gBAAgB,IAAI,KAAK;AACxF,QAAI,YAAa,eAAc,UAAU,YAAY,QAAQ,eAAe,EAAE,CAAC;AAE/E,UAAM,gBAAgB,EAAE,iBAAiB,aAAa,gBAAgB,mBAAmB;AACzF,UAAM,cAAc,8BAAO,OAAe,YAAiB,CAAC,MAAM;AAC9D,YAAM,MAAM,MAAM,MAAM,QAAS,EAAE,QAAQ,QAAQ,SAAS,eAAe,MAAM,KAAK,UAAU,EAAE,OAAO,UAAU,CAAC,EAAE,CAAC;AACvH,aAAO,MAAM,IAAI,KAAK;AAAA,IAC1B,GAHoB;AAKpB,UAAM,eAAe,QAAQ,IAAI;AACjC,QAAI,CAAC,aAAc,OAAM,IAAI,MAAM,6BAA6B;AAGhE,QAAI,WAAW;AACf,QAAI,aAAa;AACb,iBAAW,iBAAiB;AAAA,IAChC,OAAO;AACH,iBAAW,gBAAgB,YAAY,MAAM;AAAA,IACjD;AAGA,UAAM,SAAS,IAAI,IAAI,YAAY,QAAQ,EAAE;AAC7C,UAAM,SAAS,UAAU,OAAO,YAAY,EAAE,QAAQ,cAAc,GAAG,CAAC;AACxE,UAAM,QAAQ,MAAM,YAAY,0FAA0F,EAAE,GAAG,OAAO,CAAC;AACvI,QAAI,oBAAoB,MAAM,MAAM,YAAY,OAAO,KAAK,CAAC,MAAW,EAAE,KAAK,SAAS,MAAM,GAAG,MAAM,MAAM,QAAQ,IAAI;AAEzH,QAAI,CAAC,kBAAmB,OAAM,IAAI,MAAM,qCAAqC;AAG7E,UAAM,aAAa,MAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAUlC,EAAE,KAAK,YAAY,SAAS,EAAE,CAAC;AAElC,UAAM,WAAW,WAAW,MAAM,iBAAiB,SAAS,CAAC;AAC7D,QAAI,SAAS,WAAW,GAAG;AACvB,cAAQ,KAAK,0DAA0D,WAAW,EAAE;AACpF;AAAA,IACJ;AAGA,eAAW,QAAQ,UAAU;AACzB,YAAM,YAAY,KAAK,KAAK;AAC5B,cAAQ,IAAI,wCAAwC,SAAS,iBAAiB,QAAQ,kBAAkB,iBAAiB,EAAE;AAE3H,YAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAMf;AAAA,QACC,IAAI;AAAA,QACJ,QAAQ,CAAC,EAAE,WAAW,mBAAmB,SAAmB,CAAC;AAAA,MACjE,CAAC;AAAA,IACL;AAEA,YAAQ,IAAI,6CAA6C,WAAW,EAAE;AAAA,EAC1E,GAzEK;AA0ET,CAAC;",
  "names": []
}
