{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/woocommerce-products.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { bulkTranslateProducts } from \"./bulk-translate-products\";\r\nimport { db } from \"../db\";\r\nimport { integrations, users } from \"../db/schema\";\r\nimport { eq } from \"drizzle-orm\";\r\nimport { decrypt } from \"../lib/encryption\";\r\n\r\n// --- VERSIONING FOR VERIFICATION ---\r\nconst SYNC_VERSION = \"LITERAL-CLONE-V13-WCFX\";\r\n\r\n// --- CONFIGURATION FROM ENV ---\r\nconst BRAND_MODEL_TYPE_ID = process.env.SALEOR_BRAND_MODEL_TYPE_ID;\r\nconst BRAND_ATTRIBUTE_ID = process.env.SALEOR_BRAND_ATTRIBUTE_ID;\r\nconst PRODUCT_TYPE_ID = process.env.SALEOR_PRODUCT_TYPE_ID;\r\nconst CATEGORY_ID = process.env.SALEOR_CATEGORY_ID;\r\nconst DEFAULT_WAREHOUSE_ID = process.env.SALEOR_WAREHOUSE_ID;\r\nconst PHOTOROOM_API_KEY = process.env.PHOTOROOM_API_KEY;\r\nconst COUNTRY_TO_CHANNEL: Record<string, string> = {\r\n    \"AT\": \"austria\", \"BE\": \"belgium\", \"HR\": \"croatia\", \"CY\": \"cyprus\",\r\n    \"EE\": \"estonia\", \"FI\": \"finland\", \"FR\": \"france\", \"DE\": \"germany\",\r\n    \"GR\": \"greece\", \"IE\": \"ireland\", \"IT\": \"italy\", \"LV\": \"latvia\",\r\n    \"LT\": \"lithuania\", \"LU\": \"luxembourg\", \"MT\": \"malta\", \"NL\": \"netherlands\",\r\n    \"PT\": \"portugal\", \"SK\": \"slovakia\", \"SI\": \"slovenia\", \"ES\": \"spain\"\r\n};\r\n\r\n// --- HELPERS (Literal Port from Shopify Baseline) ---\r\n\r\nfunction textToEditorJs(text: string) {\r\n    const cleanText = text ? text.replace(/\\n/g, \"<br>\") : \"\";\r\n    return JSON.stringify({\r\n        time: Date.now(),\r\n        blocks: [{ type: \"paragraph\", data: { text: cleanText } }],\r\n        version: \"2.25.0\"\r\n    });\r\n}\r\n\r\n// Default Address\r\nconst DEFAULT_VENDOR_ADDRESS = {\r\n    firstName: \"Logistics\",\r\n    lastName: \"Manager\",\r\n    companyName: \"Vendor Warehouse\",\r\n    streetAddress1: \"123 Market St\",\r\n    city: \"San Francisco\",\r\n    postalCode: \"94105\",\r\n    country: \"US\",\r\n    countryArea: \"CA\"\r\n};\r\n\r\n// --- TASK DEFINITION ---\r\n\r\nexport const woocommerceProductSync = task({\r\n    id: \"woocommerce-product-sync\",\r\n    run: async (payload: { integrationId: number }) => {\r\n        console.log(`üöÄ [${SYNC_VERSION}] Execution Start. Integration: ${payload.integrationId}`);\r\n\r\n        // --- 1. SETUP & AUTH ---\r\n        const integrationData = await db.select({\r\n            id: integrations.id,\r\n            accessToken: integrations.accessToken,\r\n            storeUrl: integrations.storeUrl,\r\n            provider: integrations.provider,\r\n            brandName: users.brand,\r\n            shippingCountries: users.shippingCountries,\r\n            settings: integrations.settings\r\n        })\r\n            .from(integrations)\r\n            .innerJoin(users, eq(integrations.userId, users.id))\r\n            .where(eq(integrations.id, payload.integrationId))\r\n            .limit(1);\r\n\r\n        const integration = integrationData[0];\r\n        if (!integration) throw new Error(\"Integration not found\");\r\n\r\n        const officialBrandName = integration.brandName;\r\n        console.log(`üè∑Ô∏è  Using Official Brand Name from DB: \"${officialBrandName}\"`);\r\n        if (integration.provider !== \"woocommerce\") {\r\n            console.warn(`‚ö†Ô∏è skipping: Not WooCommerce`);\r\n            return;\r\n        }\r\n\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        // --- ü©∫ TOKEN VERIFICATION (MASKED) ---\r\n        if (saleorToken) {\r\n            const start = saleorToken.substring(0, 5);\r\n            const end = saleorToken.substring(saleorToken.length - 5);\r\n            console.log(`üîë [SECURITY] Using Saleor Token: ${start}...${end} (Length: ${saleorToken.length})`);\r\n            saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n        }\r\n\r\n        if (!apiUrl || !saleorToken) throw new Error(\"Missing SALEOR_API_URL or SALEOR_TOKEN\");\r\n        console.log(`üåê [ENV] SALEOR_API_URL: ${apiUrl}`);\r\n\r\n        const saleorHeaders = {\r\n            'Authorization': saleorToken,\r\n            'Content-Type': 'application/json'\r\n        };\r\n\r\n        // Helper: Centralized Fetch (RESILIENT TO 400 ERRORS)\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            try {\r\n                const res = await fetch(apiUrl, {\r\n                    method: 'POST',\r\n                    headers: saleorHeaders,\r\n                    body: JSON.stringify({ query, variables })\r\n                });\r\n\r\n                // Parse JSON regardless of status to handle GraphQL structural errors (HTTP 400)\r\n                const json: any = await res.json();\r\n\r\n                if (json.errors) {\r\n                    const isSchemaError = json.errors[0]?.message?.includes(\"Cannot query field\");\r\n                    if (isSchemaError) {\r\n                        console.error(\"   ‚ùå Saleor Schema Error:\", json.errors[0].message);\r\n                    } else {\r\n                        console.error(\"   ‚ùå Saleor Error:\", JSON.stringify(json.errors[0]?.message || json.errors));\r\n                    }\r\n                }\r\n                return json;\r\n            } catch (e) {\r\n                console.error(\"   ‚ùå Network Error during Saleor Request:\", e);\r\n                return {};\r\n            }\r\n        };\r\n\r\n        // --- 2. FETCH WOOCOMMERCE DATA ---\r\n        const settings = integration.settings as any;\r\n        const consumerKey = integration.accessToken;\r\n        let consumerSecret = \"\";\r\n        if (settings?.consumerSecret) consumerSecret = decrypt(settings.consumerSecret);\r\n\r\n        if (!consumerKey || !consumerSecret) throw new Error(\"Missing WC Credentials\");\r\n        const wcHeaders = {\r\n            'Authorization': `Basic ${Buffer.from(`${consumerKey}:${consumerSecret}`).toString('base64')}`,\r\n            'Content-Type': 'application/json'\r\n        };\r\n\r\n        let storeName = new URL(integration.storeUrl).hostname;\r\n        try {\r\n            const storeRes = await fetch(`${integration.storeUrl}/wp-json/`, { headers: wcHeaders });\r\n            if (storeRes.ok) {\r\n                const storeData = await storeRes.json();\r\n                if (storeData.name) storeName = storeData.name;\r\n            }\r\n        } catch (e) { console.warn(\"   ‚ö†Ô∏è store name fetch failed.\"); }\r\n\r\n        console.log(\"   üì° Connecting to WooCommerce...\");\r\n        const wcRes = await fetch(`${integration.storeUrl}/wp-json/wc/v3/products?per_page=100`, { headers: wcHeaders });\r\n        if (!wcRes.ok) throw new Error(`WC API Error: ${wcRes.status}`);\r\n        const products = await wcRes.json();\r\n        console.log(`   üì¶ Fetched ${products.length} products.`);\r\n\r\n        // --- 3. CORE SYNC FUNCTIONS ---\r\n\r\n        const getSaleorChannels = async () => {\r\n            const query = `{ channels { id slug currencyCode isActive } }`;\r\n            const json = await saleorFetch(query);\r\n            return (json.data?.channels || []).filter((c: any) => c.isActive);\r\n        };\r\n\r\n        const getOrCreateBrandPage = async (name: string) => {\r\n            if (!name) return null;\r\n            // Exact title check\r\n            const find = await saleorFetch(`query Find($n:String!){pages(filter:{search:$n},first:5){edges{node{id title isPublished}}}}`, { n: name });\r\n            const existing = find.data?.pages?.edges?.find((e: any) => e.node.title === name)?.node;\r\n\r\n            if (existing) {\r\n                if (!existing.isPublished) {\r\n                    await saleorFetch(`mutation Pub($id:ID!){pageUpdate(id:$id,input:{isPublished:true}){errors{field}}}`, { id: existing.id });\r\n                }\r\n                return existing.id;\r\n            }\r\n            console.log(`   ‚ú® Creating Brand Page: \"${name}\"`);\r\n            const create = await saleorFetch(`mutation Create($n:String!,$t:ID!){pageCreate(input:{title:$n,pageType:$t,isPublished:true,content:\"{}\"}){page{id}}}`, { n: name, t: BRAND_MODEL_TYPE_ID });\r\n            return create.data?.pageCreate?.page?.id;\r\n        };\r\n\r\n        const getOrCreateShippingZones = async () => {\r\n            const find = await saleorFetch(`query { shippingZones(first:100) { edges { node { id name } } } }`);\r\n            return find.data?.shippingZones?.edges?.map((e: any) => e.node) || [];\r\n        };\r\n\r\n        const getOrCreateWarehouse = async (vendorName: string, channels: any[]) => {\r\n            const slug = `vendor-${vendorName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;\r\n            const find = await saleorFetch(`query Find($s:String!){warehouses(filter:{search:$s},first:5){edges{node{id slug name}}}}`, { s: vendorName });\r\n\r\n            const existing = find.data?.warehouses?.edges?.find((e: any) => e.node.slug === slug || e.node.name === `${vendorName} Warehouse`)?.node;\r\n            if (existing) return existing.id;\r\n\r\n            console.log(`   üè≠ Creating Warehouse: \"${vendorName}\"`);\r\n            const inputs = {\r\n                name: `${vendorName} Warehouse`,\r\n                slug: slug,\r\n                address: DEFAULT_VENDOR_ADDRESS,\r\n                email: \"vendor@example.com\"\r\n            };\r\n\r\n            const createRes = await saleorFetch(`mutation CreateWarehouse($input:WarehouseCreateInput!){createWarehouse(input:$input){warehouse{id} errors{field message}}}`, {\r\n                input: inputs\r\n            });\r\n\r\n            const result = createRes.data?.createWarehouse;\r\n\r\n            if (result?.errors?.length > 0) {\r\n                if (result.errors.some((e: any) => e.field === 'slug')) {\r\n                    const slugSearch = await saleorFetch(`query FindS($s:String!){warehouses(filter:{search:$s},first:10){edges{node{id slug}}}}`, { s: slug });\r\n                    const found = slugSearch.data?.warehouses?.edges?.find((e: any) => e.node.slug === slug)?.node;\r\n                    if (found) return found.id;\r\n                }\r\n                console.error(\"   ‚ö†Ô∏è Warehouse Creation Failed:\", JSON.stringify(result.errors));\r\n                return null;\r\n            }\r\n\r\n            const newId = result?.warehouse?.id;\r\n            if (newId) {\r\n                console.log(`   ‚úÖ Warehouse Created: ${newId}`);\r\n                // Link to Channels\r\n                for (const ch of channels) {\r\n                    await saleorFetch(`mutation UpdCh($id:ID!,$input:ChannelUpdateInput!){channelUpdate(id:$id,input:$input){errors{field}}}`, { id: ch.id, input: { addWarehouses: [newId] } });\r\n                }\r\n                // Link to EVERY Shipping Zone\r\n                const zones = await getOrCreateShippingZones();\r\n                for (const zone of zones) {\r\n                    await saleorFetch(`mutation UpdZone($id:ID!,$input:ShippingZoneUpdateInput!){shippingZoneUpdate(id:$id,input:$input){errors{field}}}`, { id: zone.id, input: { addWarehouses: [newId] } });\r\n                }\r\n            }\r\n            return newId;\r\n        };\r\n\r\n        async function processImage(productId: string, imageUrl: string, title: string) {\r\n            console.log(\"      üé® Managing Product Media...\");\r\n\r\n            // 1. Fetch Existing Media\r\n            const mediaRes = await saleorFetch(`query GetMedia($id:ID!){product(id:$id){media{id}}}`, { id: productId });\r\n            const existingMedia = mediaRes.data?.product?.media || [];\r\n\r\n            // 2. Delete Existing Media\r\n            if (existingMedia.length > 0) {\r\n                console.log(`      üßπ Deleting ${existingMedia.length} existing images...`);\r\n                for (const media of existingMedia) {\r\n                    await saleorFetch(`mutation DelMedia($id:ID!){productMediaDelete(id:$id){errors{field message}}}`, { id: media.id });\r\n                }\r\n            }\r\n\r\n            let imageBlob: Blob | null = null;\r\n            if (PHOTOROOM_API_KEY) {\r\n                try {\r\n                    const shopifyImgRes = await fetch(imageUrl);\r\n                    if (shopifyImgRes.ok) {\r\n                        const originalBlob = await shopifyImgRes.blob();\r\n                        const formData = new FormData();\r\n                        formData.append(\"image_file\", originalBlob, \"original.jpg\");\r\n                        formData.append(\"background.color\", \"FFFFFF\");\r\n                        formData.append(\"format\", \"webp\");\r\n                        const prRes = await fetch(\"https://sdk.photoroom.com/v1/segment\", {\r\n                            method: \"POST\",\r\n                            headers: { \"x-api-key\": PHOTOROOM_API_KEY },\r\n                            body: formData\r\n                        });\r\n                        if (prRes.ok) imageBlob = await prRes.blob();\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"      ‚ùå Photoroom error:\", e);\r\n                }\r\n            }\r\n\r\n            if (imageBlob) {\r\n                const fd = new FormData();\r\n                const ops = {\r\n                    query: `mutation CreateMedia($p: ID!, $i: Upload!, $a: String) { productMediaCreate(input: { product: $p, image: $i, alt: $a }) { media { id } errors { field message } } }`,\r\n                    variables: { p: productId, i: null, a: title }\r\n                };\r\n                fd.append(\"operations\", JSON.stringify(ops));\r\n                fd.append(\"map\", JSON.stringify({ \"0\": [\"variables.i\"] }));\r\n                fd.append(\"0\", imageBlob, \"image.webp\");\r\n                await fetch(apiUrl!, { method: 'POST', headers: { 'Authorization': saleorToken }, body: fd });\r\n            } else {\r\n                await saleorFetch(`mutation AddMedia($id: ID!, $url: String!, $alt: String) { productMediaCreate(input: { product: $id, mediaUrl: $url, alt: $alt }) { media { id } errors { field message } } }`, {\r\n                    id: productId, url: imageUrl, alt: title\r\n                });\r\n            }\r\n        }\r\n\r\n        const channels = await getSaleorChannels();\r\n        const globalCountries = (integrationData[0]?.shippingCountries as string[]) || [];\r\n        const isOptOut = !globalCountries || globalCountries.length === 0;\r\n        const targetCountryCodes = isOptOut ? Object.keys(COUNTRY_TO_CHANNEL) : globalCountries;\r\n        const activeChannels = channels.filter((ch: any) => \r\n            targetCountryCodes.some((c: string) => COUNTRY_TO_CHANNEL[c] === ch.slug)\r\n        );\r\n\r\n        if (channels.length === 0) { console.error(\"‚ùå No Active Channels found.\"); return; }\r\n\r\n        // --- 4. SETUP CONTEXT (DEDUPLICATION) ---\r\n        const uniqueVendors = [officialBrandName]; // Use internal brand name\r\n        const vendorContext = new Map<string, { brandPageId: string | null, warehouseId: string | null }>();\r\n\r\n        console.log(`   üèóÔ∏è  Setting up context for ${uniqueVendors.length} unique vendors: ${uniqueVendors.join(\", \")}`);\r\n        for (const vendor of uniqueVendors) {\r\n            const brandPageId = await getOrCreateBrandPage(vendor);\r\n            let warehouseId = await getOrCreateWarehouse(vendor, channels);\r\n            if (!warehouseId) warehouseId = DEFAULT_WAREHOUSE_ID;\r\n            vendorContext.set(vendor, { brandPageId, warehouseId });\r\n        }\r\n\r\n        // --- 5. PARALLEL PROCESSING ---\r\n        console.log(`üì¶ Parallel Sync for ${products.length} products...`);\r\n\r\n        const processedProductIds: string[] = [];\r\n\r\n        await Promise.all(products.map(async (p: any) => {\r\n            const context = vendorContext.get(officialBrandName);\r\n            const brandPageId = context?.brandPageId;\r\n            const targetWarehouseId = context?.warehouseId;\r\n\r\n            let finalProductId: string | null = null;\r\n            const cleanTitle = p.name.trim();\r\n            const predictableSlug = p.slug || cleanTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-');\r\n\r\n            const slugCheck = await saleorFetch(`query FindSlug($s:String!){product(slug:$s){id}}`, { s: predictableSlug });\r\n            finalProductId = slugCheck.data?.product?.id;\r\n\r\n            if (!finalProductId) {\r\n                const createProdRes = await saleorFetch(`mutation Create($input:ProductCreateInput!){productCreate(input:$input){product{id} errors{field message}}}`, {\r\n                    input: {\r\n                        name: p.name,\r\n                        slug: predictableSlug,\r\n                        externalReference: p.id.toString(),\r\n                        productType: PRODUCT_TYPE_ID,\r\n                        category: CATEGORY_ID,\r\n                        description: textToEditorJs(p.description || p.short_description || p.name),\r\n                        metadata: [{ key: \"brand\", value: officialBrandName }]\r\n                    }\r\n                });\r\n                finalProductId = createProdRes.data?.productCreate?.product?.id;\r\n            } else {\r\n                await saleorFetch(`mutation Update($id:ID!,$input:ProductInput!){productUpdate(id:$id,input:$input){errors{field message}}}`, {\r\n                    id: finalProductId,\r\n                    input: {\r\n                        description: textToEditorJs(p.description || p.short_description || p.name),\r\n                        externalReference: p.id.toString(),\r\n                        metadata: [{ key: \"brand\", value: officialBrandName }]\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (!finalProductId) return;\r\n\r\n            if (brandPageId && BRAND_ATTRIBUTE_ID) {\r\n                await saleorFetch(`mutation UpdateProd($id:ID!,$input:ProductInput!){productUpdate(id:$id,input:$input){errors{field message}}}`, {\r\n                    id: finalProductId,\r\n                    input: { attributes: [{ id: BRAND_ATTRIBUTE_ID, reference: brandPageId }] }\r\n                });\r\n            }\r\n\r\n\r\n\r\n            if (p.images && p.images.length > 0) {\r\n                await processImage(finalProductId, p.images[0].src, p.name);\r\n            }\r\n\r\n            let wcVariations = [];\r\n            if (p.type === 'variable') {\r\n                const vRes = await fetch(`${integration.storeUrl}/wp-json/wc/v3/products/${p.id}/variations`, { headers: wcHeaders });\r\n                if (vRes.ok) wcVariations = await vRes.json();\r\n            } else {\r\n                wcVariations = [{\r\n                    id: p.id,\r\n                    sku: p.sku || `WC-${p.id}`,\r\n                    price: p.price,\r\n                    manage_stock: p.manage_stock,\r\n                    stock_quantity: p.stock_quantity,\r\n                    stock_status: p.stock_status,\r\n                    attributes: []\r\n                }];\r\n            }\r\n\r\n            const existingVarData = await saleorFetch(`query GetVars($id:ID!){product(id:$id){variants{id sku}}}`, { id: finalProductId });\r\n            const existingVariants = existingVarData.data?.product?.variants || [];\r\n            if (existingVariants.length > 0) {\r\n                await saleorFetch(`mutation BulkDelete($ids:[ID!]!){productVariantBulkDelete(ids:$ids){errors{field message}}}`, { ids: existingVariants.map((v: any) => v.id) });\r\n            }\r\n\r\n            // --- üì¶ Step 1: Create all variants ---\r\n            const variantsToProcess = [];\r\n            for (const v of wcVariations) {\r\n                const sku = v.sku || `WC-V-${v.id}`;\r\n                let quantity = 0;\r\n                if (v.manage_stock) quantity = v.stock_quantity || 0;\r\n                else quantity = v.stock_status === 'instock' ? 100 : 0;\r\n\r\n                const predictableVariantRef = `${finalProductId}-${sku}`; // Use a predictable external reference for lookup\r\n\r\n                const varRes = await saleorFetch(`mutation CreateVar($input:ProductVariantCreateInput!){productVariantCreate(input:$input){productVariant{id} errors{field message}}}`, {\r\n                    input: {\r\n                        product: finalProductId,\r\n                        sku: sku,\r\n                        name: v.attributes?.map((a: any) => (a.option || a.name)).join(' / ') || \"Default\",\r\n                        externalReference: v.id.toString(), // Store numeric ID for fulfillment\r\n                        attributes: [],\r\n                        trackInventory: true,\r\n                        stocks: targetWarehouseId ? [{ warehouse: targetWarehouseId, quantity }] : []\r\n                    }\r\n                });\r\n                const variantId = varRes.data?.productVariantCreate?.productVariant?.id;\r\n                if (variantId) {\r\n                    variantsToProcess.push({ id: variantId, price: v.price, regular_price: v.regular_price, predictableRef: predictableVariantRef });\r\n                }\r\n            }\r\n\r\n            // --- üì¢ Step 2: Ensure Product is in Channels ---\r\n            const dateStr = new Date().toISOString().split('T')[0];\r\n            const channelListings = activeChannels.map((ch: any) => ({\r\n                channelId: ch.id,\r\n                isPublished: p.status === 'publish',\r\n                publicationDate: dateStr,\r\n                isAvailableForPurchase: true,\r\n                visibleInListings: true,\r\n                availableForPurchaseAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()\r\n            }));\r\n            await saleorFetch(`mutation UpdChannel($id:ID!,$input:ProductChannelListingUpdateInput!){productChannelListingUpdate(id:$id,input:$input){errors{field}}}`, {\r\n                id: finalProductId,\r\n                input: { updateChannels: channelListings }\r\n            });\r\n\r\n            // --- üí∞ Step 3: Assign Prices to Variants ---\r\n            for (const v of variantsToProcess) {\r\n                const price = parseFloat(v.price || \"0\");\r\n                if (price > 0) {\r\n                    const priceListings = activeChannels.map((ch: any) => ({\r\n                        channelId: ch.id,\r\n                        price: price,\r\n                        costPrice: parseFloat(v.regular_price || price.toString())\r\n                    }));\r\n                    await saleorFetch(`mutation UpdVarChan($id:ID!,$input:[ProductVariantChannelListingAddInput!]!){productVariantChannelListingUpdate(id:$id,input:$input){errors{field message}}}`, {\r\n                        id: v.id,\r\n                        input: priceListings\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // üì¢ Trigger Translation\r\n            if (finalProductId) {\r\n                processedProductIds.push(finalProductId);\r\n            }\r\n        }));\r\n        \r\n        // üì¢ Trigger Bulk Translation Task\r\n        if (processedProductIds.length > 0) {\r\n            await bulkTranslateProducts.trigger({ productIds: processedProductIds });\r\n        }\r\n\r\n        console.log(`‚úÖ [LITERAL-CLONE-V11-PRICEFIX] WooCommerce sync finished.`);\r\n    }\r\n});\r\n"],
  "mappings": "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",
  "names": ["channels"]
}
