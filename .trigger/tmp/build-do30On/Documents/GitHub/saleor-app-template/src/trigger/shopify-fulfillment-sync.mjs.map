{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/shopify-fulfillment-sync.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { makeSaleorClient, WAREHOUSE_QUERY, FULFILLMENT_CREATE, ORDER_QUERY } from \"../lib/saleor-client\";\r\nimport { logDebug } from \"../lib/utils\";\r\nimport { apl } from \"../saleor-app\";\r\nimport { db } from \"../db\";\r\nimport { integrations, users } from \"../db/schema\";\r\nimport { eq, and } from \"drizzle-orm\";\r\n\r\nexport const shopifyFulfillmentSync = task({\r\n    id: \"shopify-fulfillment-sync\",\r\n    run: async (payload: {\r\n        shopifyOrderId: string,\r\n        trackingNumber?: string,\r\n        trackingUrl?: string,\r\n        vendorStoreUrl: string\r\n    }) => {\r\n        logDebug(`ðŸ”„ [Shopify -> Saleor] Syncing Fulfillment for Shopify Order: ${payload.shopifyOrderId} from ${payload.vendorStoreUrl}`);\r\n\r\n        // 1. Setup Saleor Context\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        if (!apiUrl) throw new Error(\"SALEOR_API_URL missing\");\r\n        const authData = await apl.get(apiUrl);\r\n        if (!authData || !authData.token) throw new Error(\"Saleor Auth Token missing\");\r\n        const client = makeSaleorClient(apiUrl, authData.token);\r\n\r\n        // 2. Find the Brand Slug for this Store URL\r\n        logDebug(`   ðŸ” Looking up brand for store: ${payload.vendorStoreUrl}`);\r\n        const vendorData = await db.select({ brand: users.brand })\r\n            .from(integrations)\r\n            .innerJoin(users, eq(integrations.userId, users.id))\r\n            .where(eq(integrations.storeUrl, payload.vendorStoreUrl))\r\n            .limit(1);\r\n\r\n        const brandName = vendorData[0]?.brand;\r\n        if (!brandName) {\r\n            logDebug(`   âš ï¸ Could not find brand for store URL ${payload.vendorStoreUrl}. Check integrations table.`);\r\n            // Fallback: Continue and try broad search, but this is the primary failure point\r\n        }\r\n\r\n        const brandSlug = brandName ? slugify(brandName) : null;\r\n        const metadataKey = brandSlug ? `shopify_order_id_${brandSlug}` : null;\r\n\r\n        logDebug(`   ðŸŽ¯ Target Metadata Key: ${metadataKey || '(Broad Search)'} | Value: ${payload.shopifyOrderId}`);\r\n\r\n        // 3. Find the Saleor Order by Metadata Filter (Strict)\r\n        let saleorOrder = null;\r\n\r\n        if (metadataKey) {\r\n            const findOrderQuery = `\r\n              query FindOrderByMeta($key: String!, $val: String!) {\r\n                orders(filter: { metadata: [{ key: $key, value: $val }] }, first: 1) {\r\n                  edges {\r\n                    node {\r\n                      id\r\n                      number\r\n                      lines {\r\n                        id\r\n                        quantity\r\n                        productName\r\n                        allocations {\r\n                          quantity\r\n                          warehouse { id }\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            `;\r\n            const { data: narrowData } = await client.query(findOrderQuery, { key: metadataKey, val: payload.shopifyOrderId }).toPromise();\r\n            saleorOrder = narrowData?.orders?.edges?.[0]?.node;\r\n        }\r\n\r\n        // 4. Broad Search Fallback (if key lookup failed)\r\n        if (!saleorOrder) {\r\n            logDebug(`   ðŸ•µï¸ Falling back to broad metadata scan...`);\r\n            const { data: broadData } = await client.query(`\r\n                query BroadOrderSearch($val: String!) {\r\n                    orders(first: 20, filter: { search: $val }) {\r\n                        edges {\r\n                            node {\r\n                                id\r\n                                number\r\n                                metadata { key value }\r\n                                lines {\r\n                                    id\r\n                                    quantity\r\n                                    productName\r\n                                    allocations {\r\n                                      quantity\r\n                                      warehouse { id }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            `, { val: payload.shopifyOrderId }).toPromise();\r\n\r\n            saleorOrder = broadData?.orders?.edges?.find((e: any) =>\r\n                e.node.metadata.some((m: any) => m.key.startsWith('shopify_order_id_') && m.value === payload.shopifyOrderId)\r\n            )?.node;\r\n        }\r\n\r\n        if (!saleorOrder) {\r\n            logDebug(`   âŒ No matching Saleor order found for Shopify ID ${payload.shopifyOrderId}.`);\r\n            return { status: \"not_found\" };\r\n        }\r\n\r\n        logDebug(`   âœ… Found Saleor Order: #${saleorOrder.number} (${saleorOrder.id})`);\r\n\r\n        // 5. Determine Warehouses (Default & Vendor)\r\n        let defaultWarehouseId = process.env.SALEOR_WAREHOUSE_ID;\r\n        let vendorWarehouseId: string | null = null;\r\n\r\n        // A. Fetch Default if needed\r\n        if (!defaultWarehouseId) {\r\n            const warehouseRes = await client.query(WAREHOUSE_QUERY, { search: \"\" }).toPromise();\r\n            defaultWarehouseId = warehouseRes.data?.warehouses?.edges?.[0]?.node?.id;\r\n            if (defaultWarehouseId) logDebug(`   ðŸ¢ Found Default Warehouse: ${defaultWarehouseId}`);\r\n        }\r\n\r\n        // B. Fetch Vendor Warehouse (Best Effort)\r\n        if (brandName) {\r\n            const vendorSlug = `vendor-${slugify(brandName)}`;\r\n            logDebug(`   ðŸ­ Looking for Vendor Warehouse: \"${brandName}\" (Slug: ${vendorSlug})`);\r\n\r\n            // Search by both name (broad) and filter by slug\r\n            const { data: whData } = await client.query(`\r\n                query FindWarehouse($slug: String, $search: String) {\r\n                    warehouses(filter: { slug: [$slug], search: $search }, first: 5) {\r\n                        edges { node { id name slug } }\r\n                    }\r\n                }\r\n            `, { slug: vendorSlug, search: brandName }).toPromise();\r\n\r\n            const edges = whData?.warehouses?.edges || [];\r\n            // Prioritize warehouse with \"Warehouse\" in name or matching slug\r\n            const foundWarehouse = edges.find((e: any) => e.node.slug === vendorSlug)?.node\r\n                || edges.find((e: any) => e.node.name.toLowerCase().includes(brandName.toLowerCase()))?.node;\r\n\r\n            if (foundWarehouse) {\r\n                vendorWarehouseId = foundWarehouse.id;\r\n                logDebug(`   âœ… Found Vendor Warehouse: ${foundWarehouse.name} (${vendorWarehouseId})`);\r\n            } else {\r\n                logDebug(`   âš ï¸ Vendor Warehouse not found. Will rely on Allocations or Default.`);\r\n            }\r\n        }\r\n\r\n        // 6. Execute Saleor Fulfillment\r\n        const linesToFulfill = saleorOrder.lines.map((l: any) => {\r\n            let targetWarehouse = null;\r\n            let source = \"NONE\";\r\n\r\n            if (vendorWarehouseId) {\r\n                // 1. Vendor Warehouse (Pattern Matching) - Prioritize for multi-vendor\r\n                targetWarehouse = vendorWarehouseId;\r\n                source = \"VENDOR_MATCH\";\r\n            } else if (l.allocations?.length > 0) {\r\n                // 2. Exact Allocation (Fallback)\r\n                targetWarehouse = l.allocations[0].warehouse.id;\r\n                source = \"ALLOCATION\";\r\n            } else {\r\n                // 3. Env Override or Default Fallback\r\n                targetWarehouse = process.env.SALEOR_WAREHOUSE_ID || defaultWarehouseId;\r\n                source = targetWarehouse === process.env.SALEOR_WAREHOUSE_ID ? \"ENV\" : \"DEFAULT\";\r\n            }\r\n\r\n            if (!targetWarehouse) {\r\n                throw new Error(`No warehouse found for line ${l.productName}.`);\r\n            }\r\n\r\n            logDebug(`   ðŸ“¦ Line: \"${l.productName}\" -> Warehouse: ${targetWarehouse} (Source: ${source})`);\r\n\r\n            return {\r\n                orderLineId: l.id,\r\n                stocks: [{\r\n                    quantity: l.quantity,\r\n                    warehouse: targetWarehouse\r\n                }]\r\n            };\r\n        });\r\n\r\n        logDebug(`   ðŸ“¦ Sending Fulfillment Mutation...`);\r\n\r\n        const fulfillRes = await client.mutation(FULFILLMENT_CREATE, {\r\n            order: saleorOrder.id,\r\n            input: {\r\n                lines: linesToFulfill,\r\n                trackingNumber: payload.trackingNumber,\r\n                notifyCustomer: true\r\n            }\r\n        }).toPromise();\r\n\r\n        logDebug(`   ðŸ” Raw Mutation Result:`, JSON.stringify(fulfillRes));\r\n\r\n        if (fulfillRes.error) {\r\n            logDebug(`   âŒ GraphQL Network/Auth Error:`, fulfillRes.error.message);\r\n            throw new Error(\"GraphQL Error: \" + fulfillRes.error.message);\r\n        }\r\n\r\n        if (fulfillRes.data?.orderFulfill?.errors?.length > 0) {\r\n            const errorMsg = JSON.stringify(fulfillRes.data.orderFulfill.errors);\r\n            logDebug(`   âŒ Saleor Logic Error:`, errorMsg);\r\n            throw new Error(`Saleor Fulfillment Failed: ${errorMsg}`);\r\n        } else if (fulfillRes.data?.orderFulfill?.fulfillments?.length > 0) {\r\n            logDebug(`   ðŸŽ‰ Saleor Order #${saleorOrder.number} marked as Fulfilled! ID: ${fulfillRes.data.orderFulfill.fulfillments[0].id}`);\r\n        } else {\r\n            throw new Error(\"Mutation success but no fulfillments returned?\");\r\n        }\r\n\r\n        return { success: true, orderNumber: saleorOrder.number };\r\n    }\r\n});\r\n\r\nfunction slugify(text: string) {\r\n    return text.toLowerCase().replace(/[^a-z0-9]/g, '-');\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
