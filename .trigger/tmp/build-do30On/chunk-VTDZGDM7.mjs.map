{
  "version": 3,
  "sources": ["../../../src/trigger/bulk-translate-products.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\n\r\n// --- CONFIGURATION ---\r\nconst TARGET_LANGUAGES = [\r\n    { code: \"NL\", name: \"Dutch\" },\r\n    { code: \"DE\", name: \"German\" },\r\n    { code: \"FR\", name: \"French\" },\r\n    { code: \"IT\", name: \"Italian\" },\r\n    { code: \"ES\", name: \"Spanish\" },\r\n    { code: \"PT\", name: \"Portuguese\" },\r\n    { code: \"FI\", name: \"Finnish\" },\r\n    { code: \"ET\", name: \"Estonian\" },\r\n    { code: \"LV\", name: \"Latvian\" },\r\n    { code: \"LT\", name: \"Lithuanian\" },\r\n    { code: \"SK\", name: \"Slovak\" },\r\n    { code: \"SL\", name: \"Slovenian\" },\r\n    { code: \"EL\", name: \"Greek\" },\r\n    { code: \"HR\", name: \"Croatian\" },\r\n    { code: \"MT\", name: \"Maltese\" },\r\n];\r\n\r\nexport const bulkTranslateProducts = task({\r\n    id: \"bulk-translate-products\",\r\n    run: async (payload: { productIds: string[] }) => {\r\n        const { productIds } = payload;\r\n        if (!productIds || productIds.length === 0) {\r\n            console.log(\"‚ö†Ô∏è No product IDs provided for bulk translation.\");\r\n            return;\r\n        }\r\n\r\n        console.log(`üöÄ Starting bulk translation for ${productIds.length} products...`);\r\n\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        const geminiKey = process.env.GOOGLE_API_KEY;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        if (!apiUrl || !saleorToken || !geminiKey) {\r\n            throw new Error(\"Missing SALEOR_API_URL, SALEOR_TOKEN, or GOOGLE_API_KEY\");\r\n        }\r\n\r\n        saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            const res = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Authorization': saleorToken,\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({ query, variables })\r\n            });\r\n            return await res.json();\r\n        };\r\n\r\n        // Verify Auth\r\n        try {\r\n            const shopRes = await saleorFetch(`query { shop { name } }`);\r\n            if (!shopRes.data?.shop) {\r\n                 console.error(\"‚ùå Authentication check failed. Shop query returned null.\", JSON.stringify(shopRes));\r\n            } else {\r\n                 console.log(`‚úÖ Connected to Saleor Shop: ${shopRes.data.shop.name}`);\r\n            }\r\n        } catch (e) {\r\n             console.error(\"‚ùå Error connecting to Saleor:\", e);\r\n        }\r\n\r\n        // Build Translation Alias Query Part\r\n        const translationAliases = TARGET_LANGUAGES.map(lang => \r\n            `t_${lang.code}: translation(languageCode: ${lang.code}) { name description }`\r\n        ).join(\"\\n\");\r\n\r\n        // Process products with concurrency limit\r\n        const CONCURRENCY = 5;\r\n        let processed = 0;\r\n        let failed = 0;\r\n\r\n        for (let i = 0; i < productIds.length; i += CONCURRENCY) {\r\n            const batch = productIds.slice(i, i + CONCURRENCY);\r\n            await Promise.all(batch.map(async (productId) => {\r\n                try {\r\n                    // Try getting product\r\n                    let productRes = await saleorFetch(`\r\n                        query GetProduct($id: ID!) {\r\n                            product(id: $id) {\r\n                                id\r\n                                name\r\n                                description\r\n                                ${translationAliases}\r\n                            }\r\n                        }\r\n                    `, { id: productId });\r\n\r\n                    let product = productRes.data?.product;\r\n                    \r\n                    // Fallback to Node query if Product query fails\r\n                    if (!product) {\r\n                        // console.warn(`‚ö†Ô∏è product(id: \"${productId}\") returned null. Trying node(id)...`);\r\n                        const nodeRes = await saleorFetch(`\r\n                            query GetNode($id: ID!) {\r\n                                node(id: $id) {\r\n                                    ... on Product {\r\n                                        id\r\n                                        name\r\n                                        description\r\n                                        ${translationAliases}\r\n                                    }\r\n                                }\r\n                            }\r\n                        `, { id: productId });\r\n                        product = nodeRes.data?.node;\r\n                    }\r\n\r\n                    if (!product) {\r\n                        console.error(`‚ùå Product NOT FOUND for ID: ${productId}. Skipping.`);\r\n                        console.error(\"Debug Response:\", JSON.stringify(productRes));\r\n                        failed++;\r\n                        return;\r\n                    }\r\n\r\n                    console.log(`üåç Translating: ${product.name} (${product.id})`);\r\n\r\n                    for (const lang of TARGET_LANGUAGES) {\r\n                        // Check availability via alias\r\n                        const existingTranslation = product[`t_${lang.code}`];\r\n                        \r\n                        // SKIP ONLY IF:\r\n                        // 1. Name is present\r\n                        // 2. Description is present\r\n                        // 3. Description is NOT identical to the source description (which would imply it was just verified/copied)\r\n                        //    (If description is identical, we assume it needs translation, effectively overwriting 'lazy' translations)\r\n                        const sourceDesc = product.description || \"\";\r\n                        const targetDesc = existingTranslation?.description || \"\";\r\n\r\n                        if (existingTranslation && existingTranslation.name && targetDesc && targetDesc !== sourceDesc) {\r\n                             // console.log(`   ‚è© Skipping ${lang.name} (already properly translated)`);\r\n                             continue;\r\n                        }\r\n\r\n                        console.log(`   ‚úçÔ∏è Translating to ${lang.name}...`);\r\n                        const translatedName = await translateText(product.name, lang.name, geminiKey);\r\n                        const translatedDescription = await translateText(product.description || \"\", lang.name, geminiKey, true);\r\n\r\n                        const updateRes = await saleorFetch(`\r\n                            mutation UpdateTranslation($id: ID!, $language: LanguageCodeEnum!, $input: TranslationInput!) {\r\n                                productTranslate(id: $id, languageCode: $language, input: $input) {\r\n                                    errors { field message }\r\n                                }\r\n                            }\r\n                        `, {\r\n                            id: product.id,\r\n                            language: lang.code,\r\n                            input: { name: translatedName, description: translatedDescription }\r\n                        });\r\n\r\n                        if (updateRes.data?.productTranslate?.errors?.length > 0) {\r\n                            console.error(`   ‚ùå Failed to update ${lang.name}:`, updateRes.data.productTranslate.errors);\r\n                        }\r\n                    }\r\n                    processed++;\r\n\r\n                } catch (e) {\r\n                    console.error(`‚ùå Error processing ${productId}:`, e);\r\n                    failed++;\r\n                }\r\n            }));\r\n        }\r\n        \r\n        console.log(`‚úÖ Bulk translation finished. Processed: ${processed}, Failed: ${failed}`);\r\n    }\r\n});\r\n\r\nasync function translateText(text: string, targetLanguage: string, apiKey: string, isJson: boolean = false): Promise<string> {\r\n    if (!text || text === \"{}\" || text === '{\"time\":0,\"blocks\":[],\"version\":\"2.25.0\"}') return text;\r\n\r\n    const prompt = isJson \r\n        ? `You are a professional e-commerce translator. Translate the following EditorJS JSON content into ${targetLanguage}. Keep the JSON structure identical, only translate the text values inside the blocks. Do not translate HTML tags or technical keys. Return ONLY the translated JSON.\\n\\nContent: ${text}`\r\n        : `Translate the following product name into ${targetLanguage}. If the name contains terms that are commonly used in ${targetLanguage} (like \"Snowboard\" in Dutch) or proper brand names, keep them in their original form. Return ONLY the final translated string.\\n\\nContent: ${text}`;\r\n\r\n    try {\r\n        // Updated to Gemini 2.0 Flash Lite as requested\r\n        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${apiKey}`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                contents: [{ parts: [{ text: prompt }] }]\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errText = await response.text();\r\n            console.error(`‚ùå Gemini API Error (${response.status}):`, errText);\r\n            return text;\r\n        }\r\n\r\n        const data = await response.json();\r\n        const translatedContent = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();\r\n\r\n        if (!translatedContent) {\r\n            console.warn(`‚ö†Ô∏è Gemini returned empty translation for ${targetLanguage}. Response:`, JSON.stringify(data));\r\n            return text;\r\n        }\r\n\r\n        // Clean up markdown code blocks if Gemini wrapped them\r\n        return translatedContent.replace(/^```json\\n?/, '').replace(/\\n?```$/, '');\r\n    } catch (e) {\r\n        console.error(`‚ùå Translation error for ${targetLanguage}:`, e);\r\n        return text;\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
