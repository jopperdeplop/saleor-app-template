{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/category-cleanup.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { saleorClient } from \"@/lib/saleor-client\";\r\nimport { gql } from \"urql\";\r\n\r\n// --- QUERIES ---\r\n\r\nconst GET_ALL_CATEGORIES_WITH_COUNTS = gql`\r\n  query GetCategoriesForCleanup {\r\n    categories(first: 100) {\r\n      edges { \r\n        node { \r\n          id \r\n          name \r\n          children(first: 1) { totalCount }\r\n          products(first: 1) { totalCount }\r\n        } \r\n      }\r\n    }\r\n  }\r\n`;\r\n\r\nconst DELETE_CATEGORY_MUTATION = gql`\r\n  mutation DeleteCategory($id: ID!) {\r\n    categoryDelete(id: $id) {\r\n      errors { field message }\r\n    }\r\n  }\r\n`;\r\n\r\n// --- JOB ---\r\n\r\nexport const cleanupEmptyCategories = task({\r\n  id: \"cleanup-empty-categories\",\r\n  run: async (payload: { dryRun?: boolean }) => {\r\n    // Live by default\r\n    const isDryRun = payload.dryRun === true;\r\n    \r\n    console.log(`üßπ Starting Empty Category Cleanup [LIVE: ${!isDryRun}]`);\r\n\r\n    const res = await saleorClient.query(GET_ALL_CATEGORIES_WITH_COUNTS, {}).toPromise();\r\n    if (res.error) throw new Error(res.error.message);\r\n\r\n    const categories = res.data?.categories?.edges?.map((e: any) => e.node) || [];\r\n\r\n    let deletedCount = 0;\r\n\r\n    for (const cat of categories) {\r\n      const childCount = cat.children?.totalCount || 0;\r\n      const productCount = cat.products?.totalCount || 0;\r\n\r\n      // RULE: Only delete if 0 children AND 0 products\r\n      if (childCount === 0 && productCount === 0) {\r\n        \r\n        // EXCEPTION: Check allowlist or age if possible (not implemented here without modification time in schema)\r\n        // For now, strict empty check is safe enough for \"Cleanup\".\r\n        \r\n        if (isDryRun) {\r\n           console.log(`   [DRY RUN] Would DELETE empty category: \"${cat.name}\" (${cat.id})`);\r\n        } else {\r\n           const del = await saleorClient.mutation(DELETE_CATEGORY_MUTATION, { id: cat.id }).toPromise();\r\n           if (del.error || del.data?.categoryDelete?.errors?.length > 0) {\r\n             console.error(`   ‚ùå Failed to delete \"${cat.name}\"`, del.error || del.data?.categoryDelete?.errors);\r\n           } else {\r\n             console.log(`   üóëÔ∏è DELETED \"${cat.name}\"`);\r\n             deletedCount++;\r\n           }\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`‚úÖ Cleanup Complete. Deleted: ${deletedCount}`);\r\n  }\r\n});\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;AAAA;AAEA,kBAAoB;AAIpB,IAAM,iCAAiC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAevC,IAAM,2BAA2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAU1B,IAAM,yBAAyB,KAAK;AAAA,EACzC,IAAI;AAAA,EACJ,KAAK,8BAAO,YAAkC;AAE5C,UAAM,WAAW,QAAQ,WAAW;AAEpC,YAAQ,IAAI,6CAA6C,CAAC,QAAQ,GAAG;AAErE,UAAM,MAAM,MAAM,aAAa,MAAM,gCAAgC,CAAC,CAAC,EAAE,UAAU;AACnF,QAAI,IAAI,MAAO,OAAM,IAAI,MAAM,IAAI,MAAM,OAAO;AAEhD,UAAM,aAAa,IAAI,MAAM,YAAY,OAAO,IAAI,CAAC,MAAW,EAAE,IAAI,KAAK,CAAC;AAE5E,QAAI,eAAe;AAEnB,eAAW,OAAO,YAAY;AAC5B,YAAM,aAAa,IAAI,UAAU,cAAc;AAC/C,YAAM,eAAe,IAAI,UAAU,cAAc;AAGjD,UAAI,eAAe,KAAK,iBAAiB,GAAG;AAK1C,YAAI,UAAU;AACX,kBAAQ,IAAI,8CAA8C,IAAI,IAAI,MAAM,IAAI,EAAE,GAAG;AAAA,QACpF,OAAO;AACJ,gBAAM,MAAM,MAAM,aAAa,SAAS,0BAA0B,EAAE,IAAI,IAAI,GAAG,CAAC,EAAE,UAAU;AAC5F,cAAI,IAAI,SAAS,IAAI,MAAM,gBAAgB,QAAQ,SAAS,GAAG;AAC7D,oBAAQ,MAAM,0BAA0B,IAAI,IAAI,KAAK,IAAI,SAAS,IAAI,MAAM,gBAAgB,MAAM;AAAA,UACpG,OAAO;AACL,oBAAQ,IAAI,mBAAmB,IAAI,IAAI,GAAG;AAC1C;AAAA,UACF;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAEA,YAAQ,IAAI,gCAAgC,YAAY,EAAE;AAAA,EAC5D,GAtCK;AAuCP,CAAC;",
  "names": []
}
