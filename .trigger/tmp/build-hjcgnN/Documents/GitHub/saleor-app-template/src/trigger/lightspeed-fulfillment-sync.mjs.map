{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/lightspeed-fulfillment-sync.ts"],
  "sourcesContent": ["\r\nimport { task } from \"@trigger.dev/sdk\";\r\nimport { makeSaleorClient, WAREHOUSE_QUERY, FULFILLMENT_CREATE } from \"../lib/saleor-client\";\r\nimport { logDebug } from \"../lib/utils\";\r\nimport { apl } from \"../saleor-app\";\r\nimport { db } from \"../db\";\r\nimport { integrations, users } from \"../db/schema\";\r\nimport { eq, and } from \"drizzle-orm\";\r\n\r\nexport const lightspeedFulfillmentSync = task({\r\n    id: \"lightspeed-fulfillment-sync\",\r\n    run: async (payload: {\r\n        lightspeedOrderId: string,\r\n        trackingNumber?: string,\r\n        trackingUrl?: string,\r\n        vendorStoreUrl: string // This is the domainPrefix\r\n    }) => {\r\n        logDebug(`ðŸ”„ [Lightspeed -> Saleor] Syncing Fulfillment for Lightspeed Order: ${payload.lightspeedOrderId} from ${payload.vendorStoreUrl}`);\r\n\r\n        // 1. Setup Saleor Context\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        if (!apiUrl) throw new Error(\"SALEOR_API_URL missing\");\r\n        const authData = await apl.get(apiUrl);\r\n        if (!authData || !authData.token) throw new Error(\"Saleor Auth Token missing\");\r\n        const client = makeSaleorClient(apiUrl, authData.token);\r\n\r\n        // 2. Get Integration for this Store URL\r\n        logDebug(`   ðŸ” Looking up integration for store: ${payload.vendorStoreUrl}`);\r\n        const results = await db.select({\r\n            accessToken: integrations.accessToken,\r\n            brand: users.brand\r\n        })\r\n            .from(integrations)\r\n            .innerJoin(users, eq(integrations.userId, users.id))\r\n            .where(eq(integrations.storeUrl, payload.vendorStoreUrl.toLowerCase()))\r\n            .limit(1);\r\n\r\n        const integration = results[0];\r\n        if (!integration || !integration.accessToken) {\r\n            logDebug(`   âš ï¸ Could not find active integration for store URL ${payload.vendorStoreUrl}.`);\r\n            return { status: \"not_found\" };\r\n        }\r\n\r\n        const brandName = integration.brand;\r\n        const brandSlug = brandName ? slugify(brandName) : null;\r\n        const metadataKey = brandSlug ? `lightspeed_order_id_${brandSlug}` : null;\r\n\r\n        // 3. Fetch latest data from Lightspeed if tracking is missing\r\n        let trackingNumber = payload.trackingNumber;\r\n\r\n        if (!trackingNumber) {\r\n            logDebug(`   ðŸ“¡ Fetching latest sale data for ${payload.lightspeedOrderId}...`);\r\n            const saleRes = await fetch(`https://${payload.vendorStoreUrl}.retail.lightspeed.app/api/2.0/register_sales/${payload.lightspeedOrderId}`, {\r\n                headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n            });\r\n\r\n            if (saleRes.ok) {\r\n                const saleData = await saleRes.json();\r\n                const sale = saleData.data;\r\n\r\n                // Check status - only fulfill in Saleor if completed/shipped in Lightspeed\r\n                const isCompleted = ['CLOSED', 'COMPLETED', 'SHIPPED', 'FULFILLED'].includes(sale.status?.toUpperCase());\r\n                if (!isCompleted) {\r\n                    logDebug(`   â³ Sale status is ${sale.status}. Skipping Saleor fulfillment for now.`);\r\n                    return { status: \"pending\", currentStatus: sale.status };\r\n                }\r\n\r\n                // In X-Series 2.0, tracking might be in a separate fulfillment object or register_sale_attributes\r\n                // Let's try to fetch the fulfillments for this sale\r\n                const fulfillRes = await fetch(`https://${payload.vendorStoreUrl}.retail.lightspeed.app/api/2.0/register_sales/${payload.lightspeedOrderId}/fulfillments`, {\r\n                    headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n                });\r\n\r\n                if (fulfillRes.ok) {\r\n                    const fulfillData = await fulfillRes.json();\r\n                    const latestFulfillment = fulfillData.data?.[0]; // Get most recent\r\n                    trackingNumber = latestFulfillment?.tracking_number || latestFulfillment?.delivery_track_id;\r\n                }\r\n            }\r\n        }\r\n\r\n        logDebug(`   ðŸŽ¯ Target Metadata Key: ${metadataKey || '(Broad Search)'} | Value: ${payload.lightspeedOrderId}`);\r\n\r\n        // 4. Find the Saleor Order by Metadata Filter\r\n        let saleorOrder = null;\r\n        if (metadataKey) {\r\n            const findOrderQuery = `\r\n              query FindOrderByMeta($key: String!, $val: String!) {\r\n                orders(filter: { metadata: [{ key: $key, value: $val }] }, first: 1) {\r\n                  edges {\r\n                    node {\r\n                      id\r\n                      number\r\n                      lines {\r\n                        id\r\n                        quantity\r\n                        allocations {\r\n                          quantity\r\n                          warehouse { id }\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            `;\r\n            const { data: narrowData } = await client.query(findOrderQuery, { key: metadataKey, val: payload.lightspeedOrderId }).toPromise();\r\n            saleorOrder = narrowData?.orders?.edges?.[0]?.node;\r\n        }\r\n\r\n        if (!saleorOrder) {\r\n            logDebug(`   ðŸ•µï¸ Falling back to broad metadata scan...`);\r\n            const { data: broadData } = await client.query(`\r\n                query BroadOrderSearch($val: String!) {\r\n                    orders(first: 20, filter: { search: $val }) {\r\n                        edges {\r\n                            node {\r\n                                id\r\n                                number\r\n                                metadata { key value }\r\n                                lines {\r\n                                    id\r\n                                    quantity\r\n                                    allocations {\r\n                                      quantity\r\n                                      warehouse { id }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            `, { val: payload.lightspeedOrderId }).toPromise();\r\n\r\n            saleorOrder = broadData?.orders?.edges?.find((e: any) =>\r\n                e.node.metadata.some((m: any) => m.key.startsWith('lightspeed_order_id_') && m.value === payload.lightspeedOrderId)\r\n            )?.node;\r\n        }\r\n\r\n        if (!saleorOrder) {\r\n            logDebug(`   âŒ No matching Saleor order found for Lightspeed ID ${payload.lightspeedOrderId}.`);\r\n            return { status: \"not_found\" };\r\n        }\r\n\r\n        logDebug(`   âœ… Found Saleor Order: #${saleorOrder.number} (${saleorOrder.id})`);\r\n\r\n        // 5. Execute Saleor Fulfillment\r\n        const linesToFulfill = saleorOrder.lines.map((l: any) => {\r\n            const targetWarehouse = l.allocations?.[0]?.warehouse?.id || process.env.SALEOR_WAREHOUSE_ID;\r\n            return {\r\n                orderLineId: l.id,\r\n                stocks: [{\r\n                    quantity: l.quantity,\r\n                    warehouse: targetWarehouse\r\n                }]\r\n            };\r\n        });\r\n\r\n        const fulfillRes = await client.mutation(FULFILLMENT_CREATE, {\r\n            order: saleorOrder.id,\r\n            input: {\r\n                lines: linesToFulfill,\r\n                trackingNumber: trackingNumber || payload.trackingNumber,\r\n                notifyCustomer: true\r\n            }\r\n        }).toPromise();\r\n\r\n        if (fulfillRes.data?.orderFulfill?.errors?.length > 0) {\r\n            throw new Error(`Saleor Fulfillment Failed: ${JSON.stringify(fulfillRes.data.orderFulfill.errors)}`);\r\n        }\r\n\r\n        return { success: true, orderNumber: saleorOrder.number, trackingNumber };\r\n    },\r\n});\r\n\r\nfunction slugify(text: string) {\r\n    return text.toLowerCase().replace(/[^a-z0-9]/g, '_');\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AASO,IAAM,4BAA4B,KAAK;AAAA,EAC1C,IAAI;AAAA,EACJ,KAAK,8BAAO,YAKN;AACF,aAAS,uEAAuE,QAAQ,iBAAiB,SAAS,QAAQ,cAAc,EAAE;AAG1I,UAAM,SAAS,QAAQ,IAAI;AAC3B,QAAI,CAAC,OAAQ,OAAM,IAAI,MAAM,wBAAwB;AACrD,UAAM,WAAW,MAAM,IAAI,IAAI,MAAM;AACrC,QAAI,CAAC,YAAY,CAAC,SAAS,MAAO,OAAM,IAAI,MAAM,2BAA2B;AAC7E,UAAM,SAAS,iBAAiB,QAAQ,SAAS,KAAK;AAGtD,aAAS,2CAA2C,QAAQ,cAAc,EAAE;AAC5E,UAAM,UAAU,MAAM,GAAG,OAAO;AAAA,MAC5B,aAAa,aAAa;AAAA,MAC1B,OAAO,MAAM;AAAA,IACjB,CAAC,EACI,KAAK,YAAY,EACjB,UAAU,OAAO,GAAG,aAAa,QAAQ,MAAM,EAAE,CAAC,EAClD,MAAM,GAAG,aAAa,UAAU,QAAQ,eAAe,YAAY,CAAC,CAAC,EACrE,MAAM,CAAC;AAEZ,UAAM,cAAc,QAAQ,CAAC;AAC7B,QAAI,CAAC,eAAe,CAAC,YAAY,aAAa;AAC1C,eAAS,yDAAyD,QAAQ,cAAc,GAAG;AAC3F,aAAO,EAAE,QAAQ,YAAY;AAAA,IACjC;AAEA,UAAM,YAAY,YAAY;AAC9B,UAAM,YAAY,YAAY,QAAQ,SAAS,IAAI;AACnD,UAAM,cAAc,YAAY,uBAAuB,SAAS,KAAK;AAGrE,QAAI,iBAAiB,QAAQ;AAE7B,QAAI,CAAC,gBAAgB;AACjB,eAAS,uCAAuC,QAAQ,iBAAiB,KAAK;AAC9E,YAAM,UAAU,MAAM,MAAM,WAAW,QAAQ,cAAc,iDAAiD,QAAQ,iBAAiB,IAAI;AAAA,QACvI,SAAS,EAAE,iBAAiB,UAAU,YAAY,WAAW,GAAG;AAAA,MACpE,CAAC;AAED,UAAI,QAAQ,IAAI;AACZ,cAAM,WAAW,MAAM,QAAQ,KAAK;AACpC,cAAM,OAAO,SAAS;AAGtB,cAAM,cAAc,CAAC,UAAU,aAAa,WAAW,WAAW,EAAE,SAAS,KAAK,QAAQ,YAAY,CAAC;AACvG,YAAI,CAAC,aAAa;AACd,mBAAS,uBAAuB,KAAK,MAAM,wCAAwC;AACnF,iBAAO,EAAE,QAAQ,WAAW,eAAe,KAAK,OAAO;AAAA,QAC3D;AAIA,cAAMA,cAAa,MAAM,MAAM,WAAW,QAAQ,cAAc,iDAAiD,QAAQ,iBAAiB,iBAAiB;AAAA,UACvJ,SAAS,EAAE,iBAAiB,UAAU,YAAY,WAAW,GAAG;AAAA,QACpE,CAAC;AAED,YAAIA,YAAW,IAAI;AACf,gBAAM,cAAc,MAAMA,YAAW,KAAK;AAC1C,gBAAM,oBAAoB,YAAY,OAAO,CAAC;AAC9C,2BAAiB,mBAAmB,mBAAmB,mBAAmB;AAAA,QAC9E;AAAA,MACJ;AAAA,IACJ;AAEA,aAAS,8BAA8B,eAAe,gBAAgB,aAAa,QAAQ,iBAAiB,EAAE;AAG9G,QAAI,cAAc;AAClB,QAAI,aAAa;AACb,YAAM,iBAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAoBvB,YAAM,EAAE,MAAM,WAAW,IAAI,MAAM,OAAO,MAAM,gBAAgB,EAAE,KAAK,aAAa,KAAK,QAAQ,kBAAkB,CAAC,EAAE,UAAU;AAChI,oBAAc,YAAY,QAAQ,QAAQ,CAAC,GAAG;AAAA,IAClD;AAEA,QAAI,CAAC,aAAa;AACd,eAAS,+CAA+C;AACxD,YAAM,EAAE,MAAM,UAAU,IAAI,MAAM,OAAO,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAoB5C,EAAE,KAAK,QAAQ,kBAAkB,CAAC,EAAE,UAAU;AAEjD,oBAAc,WAAW,QAAQ,OAAO;AAAA,QAAK,CAAC,MAC1C,EAAE,KAAK,SAAS,KAAK,CAAC,MAAW,EAAE,IAAI,WAAW,sBAAsB,KAAK,EAAE,UAAU,QAAQ,iBAAiB;AAAA,MACtH,GAAG;AAAA,IACP;AAEA,QAAI,CAAC,aAAa;AACd,eAAS,yDAAyD,QAAQ,iBAAiB,GAAG;AAC9F,aAAO,EAAE,QAAQ,YAAY;AAAA,IACjC;AAEA,aAAS,6BAA6B,YAAY,MAAM,KAAK,YAAY,EAAE,GAAG;AAG9E,UAAM,iBAAiB,YAAY,MAAM,IAAI,CAAC,MAAW;AACrD,YAAM,kBAAkB,EAAE,cAAc,CAAC,GAAG,WAAW,MAAM,QAAQ,IAAI;AACzE,aAAO;AAAA,QACH,aAAa,EAAE;AAAA,QACf,QAAQ,CAAC;AAAA,UACL,UAAU,EAAE;AAAA,UACZ,WAAW;AAAA,QACf,CAAC;AAAA,MACL;AAAA,IACJ,CAAC;AAED,UAAM,aAAa,MAAM,OAAO,SAAS,oBAAoB;AAAA,MACzD,OAAO,YAAY;AAAA,MACnB,OAAO;AAAA,QACH,OAAO;AAAA,QACP,gBAAgB,kBAAkB,QAAQ;AAAA,QAC1C,gBAAgB;AAAA,MACpB;AAAA,IACJ,CAAC,EAAE,UAAU;AAEb,QAAI,WAAW,MAAM,cAAc,QAAQ,SAAS,GAAG;AACnD,YAAM,IAAI,MAAM,8BAA8B,KAAK,UAAU,WAAW,KAAK,aAAa,MAAM,CAAC,EAAE;AAAA,IACvG;AAEA,WAAO,EAAE,SAAS,MAAM,aAAa,YAAY,QAAQ,eAAe;AAAA,EAC5E,GAjKK;AAkKT,CAAC;AAED,SAAS,QAAQ,MAAc;AAC3B,SAAO,KAAK,YAAY,EAAE,QAAQ,cAAc,GAAG;AACvD;AAFS;",
  "names": ["fulfillRes"]
}
