{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/lightspeed-products.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { bulkTranslateProducts } from \"./bulk-translate-products\";\r\nimport { db } from \"../db\";\r\nimport { integrations, users } from \"../db/schema\";\r\nimport { eq } from \"drizzle-orm\";\r\n\r\n// --- VERSIONING ---\r\nconst SYNC_VERSION = \"LIGHTSPEED-SYNC-V2-ROBUST\";\r\n\r\n// --- CONFIGURATION FROM ENV ---\r\nconst BRAND_MODEL_TYPE_ID = process.env.SALEOR_BRAND_MODEL_TYPE_ID;\r\nconst BRAND_ATTRIBUTE_ID = process.env.SALEOR_BRAND_ATTRIBUTE_ID;\r\nconst PRODUCT_TYPE_ID = process.env.SALEOR_PRODUCT_TYPE_ID;\r\nconst CATEGORY_ID = process.env.SALEOR_CATEGORY_ID;\r\nconst DEFAULT_WAREHOUSE_ID = process.env.SALEOR_WAREHOUSE_ID;\r\nconst COUNTRY_TO_CHANNEL: Record<string, string> = {\r\n    \"AT\": \"austria\", \"BE\": \"belgium\", \"HR\": \"croatia\", \"CY\": \"cyprus\",\r\n    \"EE\": \"estonia\", \"FI\": \"finland\", \"FR\": \"france\", \"DE\": \"germany\",\r\n    \"GR\": \"greece\", \"IE\": \"ireland\", \"IT\": \"italy\", \"LV\": \"latvia\",\r\n    \"LT\": \"lithuania\", \"LU\": \"luxembourg\", \"MT\": \"malta\", \"NL\": \"netherlands\",\r\n    \"PT\": \"portugal\", \"SK\": \"slovakia\", \"SI\": \"slovenia\", \"ES\": \"spain\"\r\n};\r\n\r\n// --- HELPERS ---\r\n\r\nfunction textToEditorJs(text: string) {\r\n    const cleanText = text ? text.replace(/\\n/g, \"<br>\") : \"\";\r\n    return JSON.stringify({\r\n        time: Date.now(),\r\n        blocks: [{ type: \"paragraph\", data: { text: cleanText } }],\r\n        version: \"2.25.0\"\r\n    });\r\n}\r\n\r\nconst DEFAULT_VENDOR_ADDRESS = {\r\n    firstName: \"Logistics\",\r\n    lastName: \"Manager\",\r\n    companyName: \"Vendor Warehouse\",\r\n    streetAddress1: \"123 Market St\",\r\n    city: \"San Francisco\",\r\n    postalCode: \"94105\",\r\n    country: \"US\",\r\n    countryArea: \"CA\"\r\n};\r\n\r\n// --- TASK DEFINITION ---\r\n\r\nexport const lightspeedProductSync = task({\r\n    id: \"lightspeed-product-sync\",\r\n    run: async (payload: { integrationId: number }) => {\r\n        console.log(`ðŸš€ [${SYNC_VERSION}] Execution Start. Integration: ${payload.integrationId}`);\r\n\r\n        // --- 1. SETUP & AUTH ---\r\n        const integrationData = await db.select({\r\n            id: integrations.id,\r\n            accessToken: integrations.accessToken,\r\n            storeUrl: integrations.storeUrl,\r\n            provider: integrations.provider,\r\n            brandName: users.brand,\r\n            shippingCountries: users.shippingCountries,\r\n            settings: integrations.settings\r\n        })\r\n            .from(integrations)\r\n            .innerJoin(users, eq(integrations.userId, users.id))\r\n            .where(eq(integrations.id, payload.integrationId))\r\n            .limit(1);\r\n\r\n        const integration = integrationData[0];\r\n        if (!integration) throw new Error(\"Integration not found\");\r\n        if (integration.provider !== \"lightspeed\") {\r\n            console.warn(`âš ï¸ skipping: Not Lightspeed`);\r\n            return;\r\n        }\r\n\r\n        const officialBrandName = integration.brandName;\r\n        console.log(`ðŸ·ï¸  Using Official Brand Name: \"${officialBrandName}\"`);\r\n\r\n        const domainPrefix = integration.storeUrl;\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        if (saleorToken) {\r\n            saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n        }\r\n\r\n        if (!apiUrl || !saleorToken) throw new Error(\"Missing SALEOR_API_URL or SALEOR_TOKEN\");\r\n\r\n        const saleorHeaders = {\r\n            'Authorization': saleorToken,\r\n            'Content-Type': 'application/json'\r\n        };\r\n\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            const res = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: saleorHeaders,\r\n                body: JSON.stringify({ query, variables })\r\n            });\r\n            const json: any = await res.json();\r\n            if (json.errors) {\r\n                console.error(\"   âŒ Saleor API Errors:\", JSON.stringify(json.errors, null, 2));\r\n            }\r\n            return json;\r\n        };\r\n\r\n        // --- 2. CORE SYNC HELPERS ---\r\n\r\n        const getSaleorChannels = async () => {\r\n            const query = `{ channels { id slug currencyCode isActive } }`;\r\n            const json = await saleorFetch(query);\r\n            return (json.data?.channels || []).filter((c: any) => c.isActive);\r\n        };\r\n\r\n        const getOrCreateBrandPage = async (name: string) => {\r\n            if (!name) return null;\r\n            const find = await saleorFetch(`query Find($n:String!){pages(filter:{search:$n},first:5){edges{node{id title isPublished}}}}`, { n: name });\r\n            const existing = find.data?.pages?.edges?.find((e: any) => e.node.title === name)?.node;\r\n            if (existing) return existing.id;\r\n\r\n            console.log(`   âœ¨ Creating Brand Page: \"${name}\"`);\r\n            const create = await saleorFetch(`mutation Create($n:String!,$t:ID!){pageCreate(input:{title:$n,pageType:$t,isPublished:true,content:\"{}\"}){page{id} errors{field message}}}`, { n: name, t: BRAND_MODEL_TYPE_ID });\r\n            return create.data?.pageCreate?.page?.id;\r\n        };\r\n\r\n        const getOrCreateShippingZones = async () => {\r\n            const find = await saleorFetch(`query { shippingZones(first:100) { edges { node { id name } } } }`);\r\n            return find.data?.shippingZones?.edges?.map((e: any) => e.node) || [];\r\n        };\r\n\r\n        const getOrCreateWarehouse = async (vendorName: string, channels: any[]) => {\r\n            const slug = `vendor-${vendorName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;\r\n            const find = await saleorFetch(`query Find($s:String!){warehouses(filter:{search:$s},first:5){edges{node{id name slug}}}}`, { s: vendorName });\r\n            const existing = find.data?.warehouses?.edges?.find((e: any) => e.node.slug === slug || e.node.name === `${vendorName} Warehouse`)?.node;\r\n            if (existing) return existing.id;\r\n\r\n            console.log(`   ðŸ­ Creating Warehouse: \"${vendorName}\"`);\r\n            const createRes = await saleorFetch(`mutation CreateWarehouse($input:WarehouseCreateInput!){createWarehouse(input:$input){warehouse{id} errors{field message}}}`, {\r\n                input: { name: `${vendorName} Warehouse`, slug, address: DEFAULT_VENDOR_ADDRESS, email: \"vendor@example.com\" }\r\n            });\r\n            const newId = createRes.data?.createWarehouse?.warehouse?.id;\r\n            if (newId) {\r\n                for (const ch of channels) {\r\n                    await saleorFetch(`mutation UpdCh($id:ID!,$input:ChannelUpdateInput!){channelUpdate(id:$id,input:$input){errors{field}}}`, { id: ch.id, input: { addWarehouses: [newId] } });\r\n                }\r\n                const zones = await getOrCreateShippingZones();\r\n                for (const zone of zones) {\r\n                    await saleorFetch(`mutation UpdZone($id:ID!,$input:ShippingZoneUpdateInput!){shippingZoneUpdate(id:$id,input:$input){errors{field}}}`, { id: zone.id, input: { addWarehouses: [newId] } });\r\n                }\r\n            }\r\n            return newId;\r\n        };\r\n\r\n        async function processImage(productId: string, imageUrl: string, title: string) {\r\n            console.log(`      ðŸŽ¨ Syncing Image: ${imageUrl}`);\r\n            // Check if media already exists to avoid duplicates\r\n            const mediaRes = await saleorFetch(`query GetMedia($id:ID!){product(id:$id){media{id}}}`, { id: productId });\r\n            if (mediaRes.data?.product?.media?.length > 0) return;\r\n\r\n            await saleorFetch(`mutation AddMedia($id: ID!, $url: String!, $alt: String) { productMediaCreate(input: { product: $id, mediaUrl: $url, alt: $alt }) { media { id } errors { field message } } }`, {\r\n                id: productId, url: imageUrl, alt: title\r\n            });\r\n        }\r\n\r\n        const channels = await getSaleorChannels();\r\n        const globalCountries = (integrationData[0]?.shippingCountries as string[]) || [];\r\n        const isOptOut = !globalCountries || globalCountries.length === 0;\r\n        const targetCountryCodes = isOptOut ? Object.keys(COUNTRY_TO_CHANNEL) : globalCountries;\r\n        const activeChannels = channels.filter((ch: any) => \r\n            targetCountryCodes.some((c: string) => COUNTRY_TO_CHANNEL[c] === ch.slug)\r\n        );\r\n\r\n        const brandPageId = await getOrCreateBrandPage(officialBrandName);\r\n        let warehouseId = await getOrCreateWarehouse(officialBrandName, activeChannels);\r\n        if (!warehouseId) warehouseId = DEFAULT_WAREHOUSE_ID;\r\n\r\n        // --- 3. FETCH DATA FROM LIGHTSPEED ---\r\n\r\n        console.log(`   ðŸ“¡ Connecting to Lightspeed: ${domainPrefix}`);\r\n\r\n        // A. Fetch Products\r\n        const lsProductRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/products`, {\r\n            headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n        });\r\n        if (!lsProductRes.ok) throw new Error(`Lightspeed Products API Error: ${lsProductRes.status}`);\r\n        const lsProductData = await lsProductRes.json();\r\n\r\n        // B. Fetch Inventory (API 2.0 requires separate call)\r\n        console.log(`   ðŸ“¦ Fetching Inventory Records...`);\r\n        const lsInventoryRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/inventory`, {\r\n            headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n        });\r\n        if (!lsInventoryRes.ok) throw new Error(`Lightspeed Inventory API Error: ${lsInventoryRes.status}`);\r\n        const lsInventoryData = await lsInventoryRes.json();\r\n\r\n        // C. Create Inventory Map\r\n        const inventoryMap = new Map<string, number>();\r\n        lsInventoryData.data?.forEach((inv: any) => {\r\n            const current = inventoryMap.get(inv.product_id) || 0;\r\n            inventoryMap.set(inv.product_id, current + parseFloat(inv.inventory_level?.toString() || \"0\"));\r\n        });\r\n\r\n        const rawProducts = lsProductData.data || [];\r\n\r\n        // Filter out \"Discount\" or system items\r\n        const products = rawProducts.filter((p: any) => {\r\n            const name = p.name.toLowerCase();\r\n            return !name.includes(\"discount\") && !name.includes(\"gift card\");\r\n        });\r\n\r\n        console.log(`   ðŸ“¦ Found ${products.length} valid products (skipped ${rawProducts.length - products.length} system items).`);\r\n\r\n        // --- 4. SYNC TO SALEOR ---\r\n\r\n        const processedProductIds: Set<string> = new Set();\r\n\r\n        for (const p of products) {\r\n            console.log(`   ðŸ”„ Syncing: ${p.name} (${p.id})`);\r\n\r\n            const predictableSlug = `ls-${p.id}`;\r\n            const slugCheck = await saleorFetch(`query Find($s:String!){product(slug:$s){id}}`, { s: predictableSlug });\r\n            let finalProductId = slugCheck.data?.product?.id;\r\n\r\n            const productInput = {\r\n                name: p.name,\r\n                slug: predictableSlug,\r\n                productType: PRODUCT_TYPE_ID,\r\n                category: CATEGORY_ID,\r\n                description: textToEditorJs(p.description || p.name),\r\n                externalReference: p.id,\r\n                metadata: [{ key: \"brand\", value: officialBrandName }]\r\n            };\r\n\r\n            if (finalProductId) {\r\n                await saleorFetch(`mutation Update($id:ID!,$input:ProductInput!){productUpdate(id:$id,input:$input){errors{field message}}}`, {\r\n                    id: finalProductId, input: productInput\r\n                });\r\n            } else {\r\n                const createRes = await saleorFetch(`mutation Create($input:ProductCreateInput!){productCreate(input:$input){product{id} errors{field message}}}`, {\r\n                    input: productInput\r\n                });\r\n                finalProductId = createRes.data?.productCreate?.product?.id;\r\n            }\r\n\r\n            if (!finalProductId) continue;\r\n\r\n            // Associate Brand\r\n            if (brandPageId && BRAND_ATTRIBUTE_ID) {\r\n                await saleorFetch(`mutation Brand($id:ID!,$input:ProductInput!){productUpdate(id:$id,input:$input){errors{field}}}`, {\r\n                    id: finalProductId, input: { attributes: [{ id: BRAND_ATTRIBUTE_ID, reference: brandPageId }] }\r\n                });\r\n            }\r\n\r\n            // Media\r\n            if (p.image_url) {\r\n                await processImage(finalProductId, p.image_url, p.name);\r\n            }\r\n\r\n            // Register in Channels\r\n            const channelListings = activeChannels.map((ch: any) => ({\r\n                channelId: ch.id, isPublished: true, isAvailableForPurchase: true, visibleInListings: true\r\n            }));\r\n            await saleorFetch(`mutation Channel($id:ID!,$input:ProductChannelListingUpdateInput!){productChannelListingUpdate(id:$id,input:$input){errors{field}}}`, {\r\n                id: finalProductId, input: { updateChannels: channelListings }\r\n            });\r\n\r\n            // Variants\r\n            // X-Series 2.0 has p.variants (array) or a single product acts as a variant\r\n            const lsVariants = p.variants || [p];\r\n\r\n            for (const v of lsVariants) {\r\n                const variantSlug = `ls-v-${v.id}`;\r\n                const varFind = await saleorFetch(`query GetV($id:ID!){product(id:$id){variants{id externalReference}}}`, { id: finalProductId });\r\n                const existingVar = varFind.data?.product?.variants?.find((ev: any) => ev.externalReference === v.id);\r\n\r\n                // --- ðŸ“¦ INVENTORY CALCULATION ---\r\n                // Fetch total stock from map (summed across outlets)\r\n                const totalStock = inventoryMap.get(v.id) || 0;\r\n                console.log(`      ðŸ“¦ Variant ${v.sku || v.id} Stock: ${totalStock}`);\r\n\r\n                const varInput = {\r\n                    product: finalProductId,\r\n                    sku: v.sku || variantSlug,\r\n                    name: v.variant_name || v.name || \"Default\",\r\n                    externalReference: v.id,\r\n                    attributes: [],\r\n                    trackInventory: true,\r\n                    stocks: [{ warehouse: warehouseId, quantity: Math.max(0, Math.floor(totalStock)) }]\r\n                };\r\n\r\n                let variantId = existingVar?.id;\r\n                if (variantId) {\r\n                    await saleorFetch(`mutation UpdV($id:ID!,$input:ProductVariantInput!){productVariantUpdate(id:$id,input:$input){errors{field message}}}`, {\r\n                        id: variantId, input: {\r\n                            sku: varInput.sku,\r\n                            name: varInput.name,\r\n                            externalReference: varInput.externalReference,\r\n                            attributes: varInput.attributes,\r\n                            trackInventory: varInput.trackInventory,\r\n                            stocks: varInput.stocks\r\n                        }\r\n                    });\r\n                } else {\r\n                    const varCreateRes = await saleorFetch(`mutation CreateV($input:ProductVariantCreateInput!){productVariantCreate(input:$input){productVariant{id} errors{field message}}}`, {\r\n                        input: varInput\r\n                    });\r\n                    variantId = varCreateRes.data?.productVariantCreate?.productVariant?.id;\r\n                }\r\n\r\n                if (variantId) {\r\n                    // --- ðŸ’° PRICING ---\r\n                    // X-Series uses 'price' (retail) and 'supply_price' (cost)\r\n                    const retailPrice = parseFloat(v.price_including_tax?.toString() || v.retail_price?.toString() || v.price?.toString() || \"0\");\r\n                    const costPrice = parseFloat(v.supply_price?.toString() || \"0\");\r\n\r\n                    console.log(`      ðŸ’° Variant ${v.sku || v.id} Price: ${retailPrice}, Cost: ${costPrice}`);\r\n\r\n                    const priceListings = activeChannels.map((ch: any) => ({\r\n                        channelId: ch.id,\r\n                        price: retailPrice,\r\n                        costPrice: costPrice > 0 ? costPrice : retailPrice\r\n                    }));\r\n\r\n                    await saleorFetch(`mutation Price($id:ID!,$input:[ProductVariantChannelListingAddInput!]!){productVariantChannelListingUpdate(id:$id,input:$input){errors{field}}}`, {\r\n                        id: variantId, input: priceListings\r\n                    });\r\n                }\r\n\r\n                // ðŸ“¢ Trigger Translation for this product\r\n                // ðŸ“¢ Trigger Translation for this product\r\n                if (finalProductId) {\r\n                    processedProductIds.add(finalProductId);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // ðŸ“¢ Trigger Bulk Translation Task\r\n        if (processedProductIds.size > 0) {\r\n            await bulkTranslateProducts.trigger({ productIds: Array.from(processedProductIds) });\r\n        }\r\n\r\n        console.log(`âœ… [${SYNC_VERSION}] Finished.`);\r\n        return { success: true, count: products.length };\r\n    },\r\n});\r\n"],
  "mappings": "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",
  "names": ["channels"]
}
