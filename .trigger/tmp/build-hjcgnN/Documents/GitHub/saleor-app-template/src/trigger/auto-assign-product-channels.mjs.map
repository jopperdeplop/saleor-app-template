{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/auto-assign-product-channels.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { db } from \"../db\";\r\nimport { users } from \"../db/schema\";\r\nimport { eq } from \"drizzle-orm\";\r\n\r\n// --- CONFIGURATION ---\r\nconst COUNTRY_TO_CHANNEL: Record<string, string> = {\r\n    \"AT\": \"austria\", \"BE\": \"belgium\", \"HR\": \"croatia\", \"CY\": \"cyprus\",\r\n    \"EE\": \"estonia\", \"FI\": \"finland\", \"FR\": \"france\", \"DE\": \"germany\",\r\n    \"GR\": \"greece\", \"IE\": \"ireland\", \"IT\": \"italy\", \"LV\": \"latvia\",\r\n    \"LT\": \"lithuania\", \"LU\": \"luxembourg\", \"MT\": \"malta\", \"NL\": \"netherlands\",\r\n    \"PT\": \"portugal\", \"SK\": \"slovakia\", \"SI\": \"slovenia\", \"ES\": \"spain\"\r\n};\r\n\r\nexport const autoAssignProductChannels = task({\r\n    id: \"auto-assign-product-channels\",\r\n    run: async (payload: { productId: string, brand: string }) => {\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        if (!apiUrl || !saleorToken) throw new Error(\"Missing SALEOR_API_URL or SALEOR_TOKEN\");\r\n        \r\n        saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            const res = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: { 'Authorization': saleorToken, 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ query, variables })\r\n            });\r\n            return await res.json();\r\n        };\r\n\r\n        console.log(`üöÄ Auto-assigning channels for Product: ${payload.productId} (Brand: ${payload.brand})`);\r\n\r\n        // 1. Get Brand Settings\r\n        const userData = await db.select().from(users).where(eq(users.brand, payload.brand)).limit(1);\r\n        const user = userData[0];\r\n        if (!user) {\r\n            console.warn(`‚ö†Ô∏è Brand settings not found for: ${payload.brand}. Skipping auto-assignment.`);\r\n            return;\r\n        }\r\n\r\n        // OPT-OUT LOGIC: Default to all 20 countries if none selected for brand\r\n        let targetCountries = (user.shippingCountries as string[]) || [];\r\n        if (targetCountries.length === 0) {\r\n            targetCountries = Object.keys(COUNTRY_TO_CHANNEL);\r\n        }\r\n\r\n        // 2. Get All Channels in Saleor\r\n        const channelsRes = await saleorFetch(`query { channels { id slug isActive } }`);\r\n        const allChannels = (channelsRes.data?.channels || []).filter((c: any) => c.isActive);\r\n        const channelSlugToId = new Map(allChannels.map((c: any) => [c.slug, c.id]));\r\n\r\n        const targetChannelSlugs = targetCountries.map(c => COUNTRY_TO_CHANNEL[c]).filter(Boolean);\r\n        const targetChannelIds = targetChannelSlugs.map(slug => channelSlugToId.get(slug)).filter(Boolean) as string[];\r\n\r\n        if (targetChannelIds.length === 0) {\r\n            console.warn(`‚ö†Ô∏è No valid channels found for countries: ${targetCountries.join(\", \")}`);\r\n            return;\r\n        }\r\n\r\n        // 3. Assign Product to Channels\r\n        const updateChannels = targetChannelIds.map(id => ({\r\n            channelId: id,\r\n            isPublished: true,\r\n            isAvailableForPurchase: true,\r\n            visibleInListings: true\r\n        }));\r\n\r\n        console.log(`üì¶ Assigning to ${targetChannelIds.length} channels...`);\r\n        const result = await saleorFetch(`\r\n            mutation UpdateProductChannels($id: ID!, $input: ProductChannelListingUpdateInput!) {\r\n                productChannelListingUpdate(id: $id, input: $input) {\r\n                    errors { field message }\r\n                }\r\n            }\r\n        `, {\r\n            id: payload.productId,\r\n            input: {\r\n                updateChannels: updateChannels\r\n            }\r\n        });\r\n\r\n        if (result.data?.productChannelListingUpdate?.errors?.length > 0) {\r\n            console.error(`‚ùå Failed to assign channels:`, JSON.stringify(result.data.productChannelListingUpdate.errors));\r\n        } else {\r\n            console.log(`‚úÖ Successfully assigned channels.`);\r\n        }\r\n    }\r\n});\r\n"],
  "mappings": "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",
  "names": []
}
