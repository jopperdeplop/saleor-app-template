{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/woocommerce-fulfillment-sync.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { makeSaleorClient, WAREHOUSE_QUERY, FULFILLMENT_CREATE } from \"../lib/saleor-client\";\r\nimport { logDebug, normalizeUrl } from \"../lib/utils\";\r\nimport { apl } from \"../saleor-app\";\r\nimport { db } from \"../db\";\r\nimport { integrations, users } from \"../db/schema\";\r\nimport { eq, and } from \"drizzle-orm\";\r\n\r\nexport const woocommerceFulfillmentSync = task({\r\n    id: \"woocommerce-fulfillment-sync\",\r\n    run: async (payload: {\r\n        woocommerceOrderId: string,\r\n        trackingNumber?: string,\r\n        trackingUrl?: string,\r\n        vendorStoreUrl: string,\r\n        brandSlug?: string\r\n    }) => {\r\n        logDebug(`ðŸ”„ [WooCommerce -> Saleor] Syncing Fulfillment for WC Order: ${payload.woocommerceOrderId} from ${payload.vendorStoreUrl}`);\r\n\r\n        // 1. Setup Saleor Context\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        if (!apiUrl) throw new Error(\"SALEOR_API_URL missing\");\r\n        const authData = await apl.get(apiUrl);\r\n        if (!authData || !authData.token) throw new Error(\"Saleor Auth Token missing\");\r\n        const client = makeSaleorClient(apiUrl, authData.token);\r\n\r\n        // 2. Find the Brand Slug for this Store URL\r\n        const normalizedSource = normalizeUrl(payload.vendorStoreUrl);\r\n        const vendorData = await db.select({ brand: users.brand })\r\n            .from(integrations)\r\n            .innerJoin(users, eq(integrations.userId, users.id))\r\n            .where(eq(integrations.storeUrl, normalizedSource))\r\n            .limit(1);\r\n\r\n        const brandName = vendorData[0]?.brand;\r\n        if (!brandName) {\r\n            logDebug(`   âš ï¸ Could not find brand for store URL ${payload.vendorStoreUrl}.`);\r\n        }\r\n\r\n        const brandSlug = payload.brandSlug || (brandName ? slugify(brandName) : null);\r\n        const metadataKey = brandSlug ? `woocommerce_order_id_${brandSlug}` : null;\r\n\r\n        logDebug(`   ðŸŽ¯ Target Metadata Key: ${metadataKey || '(Broad Search)'} | Value: ${payload.woocommerceOrderId}`);\r\n\r\n        // 3. Find the Saleor Order by Metadata Filter\r\n        let saleorOrder = null;\r\n\r\n        if (metadataKey) {\r\n            const findOrderQuery = `\r\n              query FindOrderByMeta($key: String!, $val: String!) {\r\n                orders(filter: { metadata: [{ key: $key, value: $val }] }, first: 1) {\r\n                  edges {\r\n                    node {\r\n                      id\r\n                      number\r\n                      lines {\r\n                        id\r\n                        quantity\r\n                        productName\r\n                        allocations {\r\n                          quantity\r\n                          warehouse { id }\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            `;\r\n            const { data: narrowData } = await client.query(findOrderQuery, { key: metadataKey, val: payload.woocommerceOrderId }).toPromise();\r\n            saleorOrder = narrowData?.orders?.edges?.[0]?.node;\r\n        }\r\n\r\n        // 4. Broad Search Fallback\r\n        if (!saleorOrder) {\r\n            logDebug(`   ðŸ•µï¸ Falling back to broad metadata scan...`);\r\n            const { data: broadData } = await client.query(`\r\n                query BroadOrderSearch {\r\n                    orders(first: 50) {\r\n                        edges {\r\n                            node {\r\n                                id\r\n                                number\r\n                                metadata { key value }\r\n                                lines {\r\n                                    id\r\n                                    quantity\r\n                                    productName\r\n                                    allocations {\r\n                                      quantity\r\n                                      warehouse { id }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            `, {}).toPromise();\r\n\r\n            saleorOrder = broadData?.orders?.edges?.find((e: any) =>\r\n                e.node.metadata.some((m: any) => m.key.includes('woocommerce_order_id_') && m.value === payload.woocommerceOrderId)\r\n            )?.node;\r\n        }\r\n\r\n        if (!saleorOrder) {\r\n            logDebug(`   âŒ No matching Saleor order found for WooCommerce ID ${payload.woocommerceOrderId}.`);\r\n            return { status: \"not_found\" };\r\n        }\r\n\r\n        logDebug(`   âœ… Found Saleor Order: #${saleorOrder.number} (${saleorOrder.id})`);\r\n\r\n        // 5. Determine Warehouses\r\n        let defaultWarehouseId = process.env.SALEOR_WAREHOUSE_ID;\r\n        let vendorWarehouseId: string | null = null;\r\n\r\n        if (!defaultWarehouseId) {\r\n            const warehouseRes = await client.query(WAREHOUSE_QUERY, { search: \"\" }).toPromise();\r\n            defaultWarehouseId = warehouseRes.data?.warehouses?.edges?.[0]?.node?.id;\r\n        }\r\n\r\n        if (brandName) {\r\n            const vendorSlug = `vendor-${slugify(brandName)}`;\r\n            const { data: whData } = await client.query(`\r\n                query FindWarehouse($slug: String, $search: String) {\r\n                    warehouses(filter: { slug: [$slug], search: $search }, first: 5) {\r\n                        edges { node { id name slug } }\r\n                    }\r\n                }\r\n            `, { slug: vendorSlug, search: brandName }).toPromise();\r\n\r\n            const edges = whData?.warehouses?.edges || [];\r\n            const foundWarehouse = edges.find((e: any) => e.node.slug === vendorSlug)?.node\r\n                || edges.find((e: any) => e.node.name.toLowerCase().includes(brandName.toLowerCase()))?.node;\r\n\r\n            if (foundWarehouse) {\r\n                vendorWarehouseId = foundWarehouse.id;\r\n            }\r\n        }\r\n\r\n        // 6. Execute Saleor Fulfillment\r\n        const linesToFulfill = saleorOrder.lines.map((l: any) => {\r\n            let targetWarehouse = vendorWarehouseId || (l.allocations?.length > 0 ? l.allocations[0].warehouse.id : (process.env.SALEOR_WAREHOUSE_ID || defaultWarehouseId));\r\n\r\n            if (!targetWarehouse) {\r\n                throw new Error(`No warehouse found for line ${l.productName}.`);\r\n            }\r\n\r\n            return {\r\n                orderLineId: l.id,\r\n                stocks: [{\r\n                    quantity: l.quantity,\r\n                    warehouse: targetWarehouse\r\n                }]\r\n            };\r\n        });\r\n\r\n        const fulfillRes = await client.mutation(FULFILLMENT_CREATE, {\r\n            order: saleorOrder.id,\r\n            input: {\r\n                lines: linesToFulfill,\r\n                trackingNumber: payload.trackingNumber,\r\n                notifyCustomer: true\r\n            }\r\n        }).toPromise();\r\n\r\n        if (fulfillRes.data?.orderFulfill?.errors?.length > 0) {\r\n            throw new Error(`Saleor Fulfillment Failed: ${JSON.stringify(fulfillRes.data.orderFulfill.errors)}`);\r\n        }\r\n\r\n        return { success: true, orderNumber: saleorOrder.number };\r\n    }\r\n});\r\n\r\nfunction slugify(text: string) {\r\n    return text.toLowerCase().replace(/[^a-z0-9]/g, '-');\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
