{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/multi-vendor-fulfillment.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { makeSaleorClient, ORDER_QUERY, UPDATE_ORDER_METADATA } from \"../lib/saleor-client\";\r\nimport crypto from 'crypto';\r\nimport { logDebug, OrderLine, normalizeUrl } from \"../lib/utils\";\r\nimport { apl } from \"../saleor-app\";\r\nimport { db } from \"../db\";\r\nimport { integrations, users } from \"../db/schema\";\r\nimport { eq, and } from \"drizzle-orm\";\r\nimport { decrypt } from \"../lib/encryption\";\r\n\r\nexport const automateMultiVendorFulfillment = task({\r\n    id: \"multi-vendor-fulfillment\",\r\n    retry: {\r\n        maxAttempts: 3,\r\n        minTimeoutInMs: 5000\r\n    },\r\n    run: async (payload: { orderId: string }) => {\r\n        const orderIdentifier = payload.orderId;\r\n        logDebug(`üèÅ [Multi-Vendor] Routing Order: ${orderIdentifier}`);\r\n\r\n        // 1. Setup Saleor Context\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        if (!apiUrl) throw new Error(\"SALEOR_API_URL missing\");\r\n        const authData = await apl.get(apiUrl);\r\n        if (!authData || !authData.token) throw new Error(\"Saleor Auth Token missing\");\r\n        const client = makeSaleorClient(apiUrl, authData.token);\r\n\r\n        // 2. Fetch Order Details\r\n        const { data: orderData } = await client.query(ORDER_QUERY, { id: orderIdentifier }).toPromise();\r\n        const order = orderData?.order;\r\n        if (!order) throw new Error(\"Order not found\");\r\n\r\n        // 3. Group by Brand (Vendor)\r\n        const vendorMap = new Map<string, OrderLine[]>();\r\n        for (const line of order.lines) {\r\n            if (!line.variant) continue;\r\n            const vendor = getVendorFromLine(line);\r\n            if (!vendorMap.has(vendor)) vendorMap.set(vendor, []);\r\n            vendorMap.get(vendor)!.push(line);\r\n        }\r\n\r\n        // 4. Process each Vendor Loop\r\n        for (const [vendor, lines] of vendorMap) {\r\n            logDebug(`   üè≠ Partner: ${vendor}`);\r\n\r\n            logDebug(`   üîé Checking integration for brand: \"${vendor}\"`);\r\n            const integration = await getVendorIntegration(vendor);\r\n\r\n            if (!integration) {\r\n                logDebug(`   ‚ö†Ô∏è No active integration for brand: \"${vendor}\". Order skipping mirror routing.`);\r\n                continue;\r\n            }\r\n            logDebug(`   ‚úÖ Found ${integration.provider} integration for: \"${vendor}\"`);\r\n\r\n            // B. Mirror Order Logic\r\n            const provider = integration.provider;\r\n            const metaKey = `${provider}_order_id_${slugify(vendor)}`;\r\n\r\n            let mirrorOrderId = await getLinkedOrderId(order, metaKey);\r\n\r\n            if (!mirrorOrderId) {\r\n                logDebug(`      üõí Creating Mirror Order in ${vendor}'s ${provider}...`);\r\n\r\n                if (provider === \"shopify\") {\r\n                    await ensureShopifyFulfillmentWebhook(integration);\r\n                    mirrorOrderId = await createMirrorOrderOnShopify(integration, order, lines);\r\n                } else if (provider === \"woocommerce\") {\r\n                    await ensureWooCommerceWebhook(integration);\r\n                    mirrorOrderId = await createMirrorOrderOnWooCommerce(integration, order, lines);\r\n                } else if (provider === \"lightspeed\") {\r\n                    await ensureLightspeedWebhook(integration);\r\n                    mirrorOrderId = await createMirrorOrderOnLightspeed(integration, order, lines);\r\n                }\r\n\r\n                // If this is a new integration or needs secret refresh, we should also trigger an initial sync check\r\n                // but for now we rely on the webhook.\r\n\r\n\r\n                if (mirrorOrderId) {\r\n                    await client.mutation(UPDATE_ORDER_METADATA, {\r\n                        id: order.id,\r\n                        input: [{ key: metaKey, value: mirrorOrderId }]\r\n                    }).toPromise();\r\n                }\r\n            } else {\r\n                logDebug(`      üîó Found existing mirror order: ${mirrorOrderId}`);\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    }\r\n});\r\n\r\n// --- HELPERS ---\r\n\r\nasync function ensureShopifyFulfillmentWebhook(integration: any) {\r\n    // 100% Ensure this points to the App project's fulfillment endpoint, NOT the portal.\r\n    const appUrl = process.env.SHOPIFY_WEBHOOK_URL || process.env.NEXT_PUBLIC_APP_URL || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"https://saleor-app-template-seven.vercel.app\");\r\n    const webhookUrl = `${appUrl}/api/webhooks/shopify-fulfillment`;\r\n    const topic = \"fulfillments/create\";\r\n\r\n    try {\r\n        // 1. Check existing webhooks\r\n        const listRes = await fetch(`https://${integration.storeUrl}/admin/api/2024-04/webhooks.json`, {\r\n            headers: { 'X-Shopify-Access-Token': integration.accessToken, 'Accept': 'application/json' }\r\n        });\r\n        const listJson: any = await listRes.json();\r\n        const existing = listJson.webhooks?.find((w: any) => w.topic === topic);\r\n\r\n        if (existing) {\r\n            if (existing.address === webhookUrl) {\r\n                return; // Already registered correctly\r\n            }\r\n            logDebug(`      üîÑ Updating Shopify webhook for ${integration.storeUrl}...`);\r\n            // Update existing if URL changed\r\n            await fetch(`https://${integration.storeUrl}/admin/api/2024-04/webhooks/${existing.id}.json`, {\r\n                method: 'PUT',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'X-Shopify-Access-Token': integration.accessToken\r\n                },\r\n                body: JSON.stringify({ webhook: { id: existing.id, address: webhookUrl } })\r\n            });\r\n        } else {\r\n            logDebug(`      üõ†Ô∏è Registering new fulfillment webhook for ${integration.storeUrl}...`);\r\n            // Create new\r\n            await fetch(`https://${integration.storeUrl}/admin/api/2024-04/webhooks.json`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'X-Shopify-Access-Token': integration.accessToken\r\n                },\r\n                body: JSON.stringify({\r\n                    webhook: {\r\n                        topic: topic,\r\n                        address: webhookUrl,\r\n                        format: \"json\",\r\n                        fields: [\"order_id\", \"tracking_number\", \"tracking_urls\"]\r\n                    }\r\n                })\r\n            });\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to ensure Shopify webhook for ${integration.storeUrl}. Manual setup may be needed.`);\r\n    }\r\n}\r\n\r\nasync function getVendorIntegration(brand: string) {\r\n    const res = await db.select({\r\n        accessToken: integrations.accessToken,\r\n        storeUrl: integrations.storeUrl,\r\n        provider: integrations.provider,\r\n        settings: integrations.settings,\r\n        brand: users.brand\r\n    })\r\n        .from(integrations)\r\n        .innerJoin(users, eq(integrations.userId, users.id))\r\n        .where(and(eq(users.brand, brand), eq(integrations.status, \"active\")))\r\n        .limit(1);\r\n    return res[0] as any;\r\n}\r\n\r\nasync function getLinkedOrderId(order: any, key: string) {\r\n    const meta = order.metadata?.find((m: any) => m.key === key);\r\n    return meta?.value;\r\n}\r\n\r\nasync function createMirrorOrderOnShopify(integration: any, order: any, lines: any[]) {\r\n    const payload = {\r\n        order: {\r\n            line_items: lines.map(l => ({\r\n                variant_id: l.variant.externalReference ? l.variant.externalReference.split('/').pop() : l.variant.sku,\r\n                quantity: l.quantity,\r\n                title: l.productName\r\n            })),\r\n            customer: {\r\n                first_name: order.shippingAddress?.firstName || \"Customer\",\r\n                last_name: order.shippingAddress?.lastName || \"\",\r\n                email: order.userEmail\r\n            },\r\n            shipping_address: order.shippingAddress ? {\r\n                first_name: order.shippingAddress.firstName,\r\n                last_name: order.shippingAddress.lastName,\r\n                address1: order.shippingAddress.streetAddress1,\r\n                address2: order.shippingAddress.streetAddress2,\r\n                city: order.shippingAddress.city,\r\n                zip: order.shippingAddress.postalCode,\r\n                country_code: order.shippingAddress.country.code,\r\n                phone: order.shippingAddress.phone || \"0000000000\"\r\n            } : undefined,\r\n            financial_status: \"paid\",\r\n            tags: \"Marketplace-Order\"\r\n        }\r\n    };\r\n\r\n    try {\r\n        const res = await fetch(`https://${integration.storeUrl}/admin/api/2024-04/orders.json`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json',\r\n                'X-Shopify-Access-Token': integration.accessToken\r\n            },\r\n            body: JSON.stringify(payload)\r\n        });\r\n        const text = await res.text();\r\n        if (res.ok) {\r\n            const json = JSON.parse(text);\r\n            logDebug(`      ‚úÖ Mirror order created: ${json.order.id}`);\r\n            return json.order.id.toString();\r\n        } else {\r\n            logDebug(`      ‚ùå Shopify Order Creation Failed:`, text);\r\n            return null;\r\n        }\r\n    } catch (err: any) {\r\n        logDebug(`      ‚ùå Network error creating Shopify order: ${err.message}`);\r\n        return null;\r\n    }\r\n}\r\n\r\nasync function ensureWooCommerceWebhook(integration: any) {\r\n    const settings = (integration.settings || {}) as any;\r\n    const consumerKey = integration.accessToken;\r\n    const consumerSecret = settings?.consumerSecret ? decrypt(settings.consumerSecret) : \"\";\r\n\r\n    if (!consumerKey || !consumerSecret) return;\r\n\r\n    // 1. Secret Management & URL Normalization\r\n    const normalizedStoreUrl = normalizeUrl(integration.storeUrl);\r\n\r\n    // Proactively normalize the URL in the DB if it's not already\r\n    if (integration.storeUrl !== normalizedStoreUrl) {\r\n        logDebug(`      üìè Normalizing Store URL in DB: ${integration.storeUrl} -> ${normalizedStoreUrl}`);\r\n        await db.update(integrations)\r\n            .set({ storeUrl: normalizedStoreUrl })\r\n            .where(eq(integrations.id, integration.id));\r\n    }\r\n\r\n    let webhookSecret = settings.webhookSecret;\r\n    let needsSync = settings.webhookSecretSynced !== true;\r\n    let justGenerated = false;\r\n\r\n    if (!webhookSecret) {\r\n        logDebug(`      üîê Generating new WooCommerce Webhook Secret for ${normalizedStoreUrl}...`);\r\n        webhookSecret = crypto.randomBytes(32).toString('hex');\r\n        justGenerated = true;\r\n        needsSync = true;\r\n\r\n        // Save back to DB\r\n        await db.update(integrations)\r\n            .set({ settings: { ...settings, webhookSecret, webhookSecretSynced: false } })\r\n            .where(eq(integrations.id, integration.id));\r\n    }\r\n\r\n    const auth = Buffer.from(`${consumerKey}:${consumerSecret}`).toString('base64');\r\n    const appUrl = process.env.SHOPIFY_WEBHOOK_URL || process.env.NEXT_PUBLIC_APP_URL || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"https://saleor-app-template-seven.vercel.app\");\r\n    const webhookUrl = `${appUrl}/api/webhooks/woocommerce-fulfillment`;\r\n\r\n    try {\r\n        const listRes = await fetch(`${normalizedStoreUrl}/wp-json/wc/v3/webhooks`, {\r\n            headers: { 'Authorization': `Basic ${auth}` }\r\n        });\r\n        const listJson: any = await listRes.json();\r\n        const topic = \"order.updated\";\r\n        const existing = Array.isArray(listJson) ? listJson.find((w: any) => w.topic === topic && normalizeUrl(w.delivery_url) === normalizeUrl(webhookUrl)) : null;\r\n\r\n        if (!existing || needsSync) {\r\n            if (existing) {\r\n                logDebug(`      üõ°Ô∏è Syncing WooCommerce webhook secret for ${normalizedStoreUrl}...`);\r\n                await fetch(`${normalizedStoreUrl}/wp-json/wc/v3/webhooks/${existing.id}`, {\r\n                    method: 'PUT',\r\n                    headers: {\r\n                        'Content-Type': 'application/json',\r\n                        'Authorization': `Basic ${auth}`\r\n                    },\r\n                    body: JSON.stringify({\r\n                        secret: webhookSecret\r\n                    })\r\n                });\r\n            } else {\r\n                logDebug(`      üõ†Ô∏è Registering WooCommerce webhook for ${normalizedStoreUrl}...`);\r\n                await fetch(`${normalizedStoreUrl}/wp-json/wc/v3/webhooks`, {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Content-Type': 'application/json',\r\n                        'Authorization': `Basic ${auth}`\r\n                    },\r\n                    body: JSON.stringify({\r\n                        name: \"Marketplace Fulfillment Sync\",\r\n                        topic: topic,\r\n                        delivery_url: webhookUrl,\r\n                        status: \"active\",\r\n                        secret: webhookSecret\r\n                    })\r\n                });\r\n            }\r\n\r\n            // Mark as synced in DB\r\n            await db.update(integrations)\r\n                .set({ settings: { ...settings, webhookSecret, webhookSecretSynced: true } })\r\n                .where(eq(integrations.id, integration.id));\r\n            logDebug(`      ‚úÖ Webhook secret confirmed and synced for ${normalizedStoreUrl}.`);\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to ensure WooCommerce webhook for ${normalizedStoreUrl}: ${e instanceof Error ? e.message : String(e)}`);\r\n    }\r\n}\r\n\r\nasync function ensureLightspeedWebhook(integration: any) {\r\n    const settings = (integration.settings || {}) as any;\r\n    const webhookSecret = settings.webhookSecret ? decrypt(settings.webhookSecret) : \"\";\r\n    if (!webhookSecret) return;\r\n\r\n    const appUrl = process.env.SHOPIFY_WEBHOOK_URL || process.env.NEXT_PUBLIC_APP_URL || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"https://saleor-app-template-seven.vercel.app\");\r\n    const webhookUrl = `${appUrl}/api/webhooks/lightspeed-fulfillment?secret=${webhookSecret}`;\r\n\r\n    try {\r\n        // 1. Check existing webhooks\r\n        const listRes = await fetch(`https://${integration.storeUrl}.retail.lightspeed.app/api/webhooks`, {\r\n            headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n        });\r\n        if (!listRes.ok) {\r\n            const listErr = await listRes.text();\r\n            logDebug(`      ‚ùå Failed to list Lightspeed webhooks: ${listRes.status} ${listErr}`);\r\n            return;\r\n        }\r\n\r\n        const listJson: any = await listRes.json();\r\n        const topic = \"sale.update\";\r\n        const existing = Array.isArray(listJson) ? listJson.find((w: any) => w.type === topic) : null;\r\n\r\n        if (existing) {\r\n            if (existing.url === webhookUrl) {\r\n                return; // Already registered correctly\r\n            }\r\n            logDebug(`      üîÑ Updating Lightspeed webhook for ${integration.storeUrl}...`);\r\n            const upRes = await fetch(`https://${integration.storeUrl}.retail.lightspeed.app/api/webhooks/${existing.id}`, {\r\n                method: 'PUT',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${integration.accessToken}`\r\n                },\r\n                body: JSON.stringify({ active: true, url: webhookUrl })\r\n            });\r\n            if (!upRes.ok) {\r\n                const upErr = await upRes.text();\r\n                logDebug(`      ‚ùå Failed to update Lightspeed webhook: ${upRes.status} ${upErr}`);\r\n            }\r\n        } else {\r\n            logDebug(`      üõ†Ô∏è Registering new Lightspeed webhook for ${integration.storeUrl}...`);\r\n            const regRes = await fetch(`https://${integration.storeUrl}.retail.lightspeed.app/api/webhooks`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${integration.accessToken}`\r\n                },\r\n                body: JSON.stringify({\r\n                    active: true,\r\n                    type: topic,\r\n                    url: webhookUrl\r\n                })\r\n            });\r\n            if (!regRes.ok) {\r\n                const regErr = await regRes.text();\r\n                logDebug(`      ‚ùå Failed to register Lightspeed webhook: ${regRes.status} ${regErr}`);\r\n            } else {\r\n                logDebug(`      ‚úÖ Lightspeed webhook [${topic}] registered successfully.`);\r\n            }\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to ensure Lightspeed webhook for ${integration.storeUrl}: ${e instanceof Error ? e.message : String(e)}`);\r\n    }\r\n}\r\n\r\nasync function createMirrorOrderOnWooCommerce(integration: any, order: any, lines: any[]) {\r\n    const settings = integration.settings as any;\r\n    const consumerKey = integration.accessToken;\r\n    const consumerSecret = settings?.consumerSecret ? decrypt(settings.consumerSecret) : \"\";\r\n\r\n    if (!consumerKey || !consumerSecret) return null;\r\n\r\n    const auth = Buffer.from(`${consumerKey}:${consumerSecret}`).toString('base64');\r\n\r\n    const payload = {\r\n        payment_method: \"other\",\r\n        payment_method_title: \"Marketplace Proxy\",\r\n        set_paid: true,\r\n        billing: {\r\n            first_name: order.billingAddress?.firstName || order.shippingAddress?.firstName || \"Customer\",\r\n            last_name: order.billingAddress?.lastName || order.shippingAddress?.lastName || \"\",\r\n            address_1: order.billingAddress?.streetAddress1 || order.shippingAddress?.streetAddress1 || \"\",\r\n            city: order.billingAddress?.city || order.shippingAddress?.city || \"\",\r\n            postcode: order.billingAddress?.postalCode || order.shippingAddress?.postalCode || \"\",\r\n            country: order.billingAddress?.country.code || order.shippingAddress?.country.code || \"US\",\r\n            email: order.userEmail\r\n        },\r\n        shipping: order.shippingAddress ? {\r\n            first_name: order.shippingAddress.firstName,\r\n            last_name: order.shippingAddress.lastName,\r\n            address_1: order.shippingAddress.streetAddress1,\r\n            city: order.shippingAddress.city,\r\n            postcode: order.shippingAddress.postalCode,\r\n            country: order.shippingAddress.country.code\r\n        } : undefined,\r\n        line_items: lines.map(l => {\r\n            const extRef = l.variant?.externalReference || \"0\";\r\n            const numericId = parseInt(extRef);\r\n\r\n            const item: any = {\r\n                product_id: parseInt(l.variant?.product?.externalReference || \"0\"),\r\n                quantity: l.quantity\r\n            };\r\n\r\n            if (l.variant?.name !== \"Default\" && !isNaN(numericId) && numericId > 0) {\r\n                item.variation_id = numericId;\r\n            }\r\n\r\n            return item;\r\n        }),\r\n        customer_note: `Marketplace Order: ${order.number}`\r\n    };\r\n\r\n    try {\r\n        const res = await fetch(`${integration.storeUrl}/wp-json/wc/v3/orders`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Basic ${auth}`\r\n            },\r\n            body: JSON.stringify(payload)\r\n        });\r\n\r\n        const json: any = await res.json();\r\n        if (res.ok && json.id) {\r\n            logDebug(`      ‚úÖ WC Mirror order created: ${json.id}`);\r\n            return json.id.toString();\r\n        } else {\r\n            logDebug(`      ‚ùå WC Order Creation Failed:`, JSON.stringify(json));\r\n            return null;\r\n        }\r\n    } catch (err: any) {\r\n        logDebug(`      ‚ùå Network error creating WC order: ${err.message}`);\r\n        return null;\r\n    }\r\n}\r\n\r\nasync function createMirrorOrderOnLightspeed(integration: any, order: any, lines: any[]) {\r\n    const domainPrefix = integration.storeUrl;\r\n\r\n    // 1. Fetch available registers and find one that looks like a web/main register\r\n    let registerId = \"default\";\r\n    try {\r\n        const regRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/registers`, {\r\n            headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n        });\r\n        if (regRes.ok) {\r\n            const regData = await regRes.json();\r\n            // Prefer a register with 'main' or 'web' in the name\r\n            const preferred = regData.data?.find((r: any) =>\r\n                r.name.toLowerCase().includes('main') ||\r\n                r.name.toLowerCase().includes('web') ||\r\n                r.name.toLowerCase().includes('ecommerce')\r\n            );\r\n            registerId = preferred?.id || regData.data?.[0]?.id || \"default\";\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to fetch registers, falling back to 'default'.`);\r\n    }\r\n\r\n    // 2. Fetch available users to get a valid UUID for user_id\r\n    let userId = \"\";\r\n    try {\r\n        const userRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/users`, {\r\n            headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n        });\r\n        if (userRes.ok) {\r\n            const userData = await userRes.json();\r\n            // Try to find primary user, fallback to first user\r\n            const primaryUser = userData.data?.find((u: any) => u.is_primary_user);\r\n            userId = primaryUser?.id || userData.data?.[0]?.id;\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to fetch users.`);\r\n    }\r\n\r\n    if (!userId) {\r\n        logDebug(`      ‚ùå Could not find a valid user_id for Lightspeed sale creation.`);\r\n        return null;\r\n    }\r\n\r\n    // 3. Find or Create Customer\r\n    let customerId = null;\r\n    try {\r\n        const email = order.userEmail;\r\n        if (email) {\r\n            logDebug(`      üîç Searching for Lightspeed customer: ${email}`);\r\n            const searchRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/search?type=customers&email=${encodeURIComponent(email)}`, {\r\n                headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n            });\r\n            if (searchRes.ok) {\r\n                const searchData = await searchRes.json();\r\n                if (searchData.data?.[0]?.id) {\r\n                    customerId = searchData.data[0].id;\r\n                    logDebug(`      ‚úÖ Found existing customer: ${customerId}`);\r\n                } else {\r\n                    logDebug(`      üë§ Creating new customer in Lightspeed...`);\r\n                    const createRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/customers`, {\r\n                        method: 'POST',\r\n                        headers: {\r\n                            'Authorization': `Bearer ${integration.accessToken}`,\r\n                            'Content-Type': 'application/json'\r\n                        },\r\n                        body: JSON.stringify({\r\n                            first_name: order.shippingAddress?.firstName || \"Customer\",\r\n                            last_name: order.shippingAddress?.lastName || \"Saleor\",\r\n                            email: email,\r\n                            physical_address1: order.shippingAddress?.streetAddress1 || \"\",\r\n                            physical_address2: order.shippingAddress?.streetAddress2 || \"\",\r\n                            physical_city: order.shippingAddress?.city || \"\",\r\n                            physical_postcode: order.shippingAddress?.postalCode || \"\",\r\n                            physical_country_id: order.shippingAddress?.country.code || \"\",\r\n                            postal_address1: order.shippingAddress?.streetAddress1 || \"\",\r\n                            postal_address2: order.shippingAddress?.streetAddress2 || \"\",\r\n                            postal_city: order.shippingAddress?.city || \"\",\r\n                            postal_postcode: order.shippingAddress?.postalCode || \"\",\r\n                            postal_country_id: order.shippingAddress?.country.code || \"\"\r\n                        })\r\n                    });\r\n                    if (createRes.ok) {\r\n                        const createData = await createRes.json();\r\n                        customerId = createData.data?.id;\r\n                        logDebug(`      ‚úÖ Created customer: ${customerId} with physical address`);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to sync customer.`);\r\n    }\r\n\r\n    // 4. Get Payment Type for \"Paid\" status\r\n    let paymentTypeId = null;\r\n    try {\r\n        const payRes = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/2.0/payment_types`, {\r\n            headers: { 'Authorization': `Bearer ${integration.accessToken}` }\r\n        });\r\n        if (payRes.ok) {\r\n            const payData = await payRes.json();\r\n            // Prefer \"Saleor\", \"Marketplace\", \"Online\", or \"Card\"\r\n            const target = payData.data?.find((p: any) =>\r\n                p.name.toLowerCase().includes('saleor') ||\r\n                p.name.toLowerCase().includes('marketplace') ||\r\n                p.name.toLowerCase().includes('online') ||\r\n                p.name.toLowerCase().includes('card')\r\n            ) || payData.data?.[0];\r\n            paymentTypeId = target?.id;\r\n        }\r\n    } catch (e) {\r\n        logDebug(`      ‚ö†Ô∏è Failed to fetch payment types.`);\r\n    }\r\n\r\n    const totalAmount = lines.reduce((acc, l) => acc + ((l.unitPrice?.gross?.amount ?? 0) * l.quantity), 0);\r\n\r\n    const payload: any = {\r\n        register_id: registerId,\r\n        state: \"parked\", // Ensures the sale stays open for fulfillment\r\n        fulfillment_status: \"OPEN\", // Top-level flag for 0.9 web sales\r\n        is_web_order: true, // Top-level flag for 0.9 web sales\r\n        user_id: userId,\r\n        customer_id: customerId,\r\n        register_sale_products: lines.map(line => ({\r\n            product_id: line.variant?.externalReference || line.variant?.sku,\r\n            quantity: line.quantity,\r\n            price: line.unitPrice?.gross?.amount ?? 0,\r\n            tax: 0\r\n        })),\r\n        note: `Saleor Order: ${order.number}`\r\n    };\r\n\r\n    if (paymentTypeId) {\r\n        payload.register_sale_payments = [{\r\n            retailer_payment_type_id: paymentTypeId,\r\n            amount: totalAmount\r\n        }];\r\n    }\r\n\r\n    try {\r\n        logDebug(`      üì° Sending payload to Lightspeed 0.9 API: /api/register_sales`);\r\n        const res = await fetch(`https://${domainPrefix}.retail.lightspeed.app/api/register_sales`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${integration.accessToken}`,\r\n                'Content-Type': 'application/json'\r\n            },\r\n            body: JSON.stringify(payload)\r\n        });\r\n\r\n        const json: any = await res.json();\r\n        const saleId = json.register_sale?.id || json.data?.id;\r\n\r\n        if (res.ok && saleId) {\r\n            logDebug(`      ‚úÖ Lightspeed Mirror Sale created: ${saleId} on Register: ${registerId} (Customer: ${customerId || 'N/A'}, Status: Paid)`);\r\n            return saleId.toString();\r\n        } else {\r\n            logDebug(`      ‚ùå Lightspeed Sale Creation Failed:`, JSON.stringify(json));\r\n            return null;\r\n        }\r\n    } catch (err: any) {\r\n        logDebug(`      ‚ùå Network error creating Lightspeed sale: ${err.message}`);\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction getVendorFromLine(line: any): string {\r\n    const brandAttr = line.variant?.product?.attributes?.find((a: any) => a.attribute.slug === \"brand\");\r\n    return brandAttr?.values[0]?.name || \"Unknown\";\r\n}\r\n\r\nfunction slugify(text: string) {\r\n    return text.toLowerCase().replace(/[^a-z0-9]/g, '_');\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
