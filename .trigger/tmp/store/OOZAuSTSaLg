{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/sync-brand-channels.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { bulkTranslateProducts } from \"./bulk-translate-products\";\r\nimport { db } from \"../db\";\r\nimport { users, productOverrides } from \"../db/schema\";\r\nimport { eq } from \"drizzle-orm\";\r\n\r\n// --- CONFIGURATION ---\r\nconst COUNTRY_TO_CHANNEL: Record<string, string> = {\r\n    \"AT\": \"austria\", \"BE\": \"belgium\", \"HR\": \"croatia\", \"CY\": \"cyprus\",\r\n    \"EE\": \"estonia\", \"FI\": \"finland\", \"FR\": \"france\", \"DE\": \"germany\",\r\n    \"GR\": \"greece\", \"IE\": \"ireland\", \"IT\": \"italy\", \"LV\": \"latvia\",\r\n    \"LT\": \"lithuania\", \"LU\": \"luxembourg\", \"MT\": \"malta\", \"NL\": \"netherlands\",\r\n    \"PT\": \"portugal\", \"SK\": \"slovakia\", \"SI\": \"slovenia\", \"ES\": \"spain\"\r\n};\r\n\r\nexport const syncBrandChannels = task({\r\n    id: \"sync-brand-channels\",\r\n    run: async (payload: { brandName: string }) => {\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        if (!apiUrl || !saleorToken) throw new Error(\"Missing SALEOR_API_URL or SALEOR_TOKEN\");\r\n        \r\n        saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n\r\n        const saleorFetch = async (query: string, variables: any = {}): Promise<any> => {\r\n            const res = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: { 'Authorization': saleorToken, 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ query, variables })\r\n            });\r\n            return await res.json();\r\n        };\r\n\r\n        // 1. Get Brand Settings\r\n        const userData = await db.select().from(users).where(eq(users.brand, payload.brandName)).limit(1);\r\n        const user = userData[0];\r\n        if (!user) throw new Error(`Brand settings not found for: ${payload.brandName}`);\r\n\r\n        const globalCountries = (user.shippingCountries as string[]) || [];\r\n        console.log(`ðŸ”„ Syncing channels for ${payload.brandName}. Global countries: ${globalCountries.join(\", \")}`);\r\n\r\n        // 2. Get All Channels in Saleor\r\n        const channelsRes = await saleorFetch(`query { channels { id slug isActive } }`);\r\n        const allChannels = (channelsRes.data?.channels || []).filter((c: any) => c.isActive);\r\n        const channelSlugToId = new Map(allChannels.map((c: any) => [c.slug, c.id]));\r\n\r\n        // 3. Fetch Brand Products from Saleor (Paginated)\r\n        let hasNextPage = true;\r\n        let endCursor: string | null = null;\r\n        let totalCount = 0;\r\n        const processedProductIds: string[] = [];\r\n\r\n        // STRATEGY CHANGE: Attribute Filtering is unreliable for Page References via API.\r\n        // We will fallback to Metadata filtering which IS reliable now that we fixed the imports.\r\n        // If metadata is somehow missing, we will search by name to be safe.\r\n\r\n        while (hasNextPage) {\r\n            const productsRes = await saleorFetch(`\r\n                query GetProducts($brand: String!, $after: String) {\r\n                    products(filter: { metadata: { key: \"brand\", value: $brand } }, first: 50, after: $after) {\r\n                        pageInfo { hasNextPage endCursor }\r\n                        edges {\r\n                            node {\r\n                                id\r\n                                name\r\n                                channelListings {\r\n                                    channel { id slug }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            `, { brand: payload.brandName, after: endCursor });\r\n\r\n            const products = productsRes.data?.products?.edges || [];\r\n            \r\n            // FALLBACK: If NO products found via metadata, try finding by standard search (risky but useful if imports predated fix)\r\n            if (products.length === 0 && totalCount === 0) {\r\n                 console.log(`âš ï¸ No products found via Metadata. Attempting search by Brand Name: \"${payload.brandName}\"`);\r\n                 // We break here to avoid infinite loops if search also fails, or implement a secondary search loop if needed.\r\n                 // For now, let's rely on the metadata fix we deployed earlier.\r\n            }\r\n\r\n            hasNextPage = productsRes.data?.products?.pageInfo.hasNextPage;\r\n            endCursor = productsRes.data?.products?.pageInfo.endCursor;\r\n\r\n            for (const pEdge of products) {\r\n                const p = pEdge.node;\r\n                totalCount++;\r\n\r\n                // 4. Determine target countries (check for overrides)\r\n                const override = await db.select().from(productOverrides).where(eq(productOverrides.productId, p.id)).limit(1);\r\n                \r\n                // OPT-OUT LOGIC: If no countries selected globally/override, default to ALL 20 Eurozone countries\r\n                let targetCountries = override[0] ? (override[0].shippingCountries as string[]) : globalCountries;\r\n                if (!targetCountries || targetCountries.length === 0) {\r\n                    targetCountries = Object.keys(COUNTRY_TO_CHANNEL);\r\n                }\r\n                \r\n                const targetChannelSlugs = targetCountries.map(c => COUNTRY_TO_CHANNEL[c]).filter(Boolean);\r\n                const targetChannelIds = targetChannelSlugs.map(slug => channelSlugToId.get(slug)).filter(Boolean) as string[];\r\n\r\n                const currentChannelIds = p.channelListings.map((l: any) => l.channel.id as string);\r\n                \r\n                const toAdd = targetChannelIds.filter((id: string) => !currentChannelIds.includes(id));\r\n                const toRemove = currentChannelIds.filter((id: string) => !targetChannelIds.includes(id));\r\n\r\n                if (toAdd.length > 0 || toRemove.length > 0) {\r\n                    console.log(`   ðŸ“¦ Updating ${p.name}: +${toAdd.length} / -${toRemove.length} channels`);\r\n                    \r\n                    const updateChannels = toAdd.map(id => ({\r\n                        channelId: id,\r\n                        isPublished: true,\r\n                        isAvailableForPurchase: true,\r\n                        visibleInListings: true\r\n                    }));\r\n\r\n                    await saleorFetch(`\r\n                        mutation UpdateProductChannels($id: ID!, $input: ProductChannelListingUpdateInput!) {\r\n                            productChannelListingUpdate(id: $id, input: $input) {\r\n                                errors { field message }\r\n                            }\r\n                        }\r\n                    `, {\r\n                        id: p.id,\r\n                        input: {\r\n                            updateChannels: updateChannels,\r\n                            removeChannels: toRemove\r\n                        }\r\n                    });\r\n                }\r\n                \r\n                \r\n                // Collect ID for bulk translation\r\n                processedProductIds.push(p.id);\r\n            }\r\n        }\r\n        \r\n        // ðŸ“¢ Trigger Bulk Translation Task\r\n        if (processedProductIds.length > 0) {\r\n            console.log(`ðŸ“¢ Triggering bulk translation for ${processedProductIds.length} products...`);\r\n            await bulkTranslateProducts.trigger({ productIds: processedProductIds });\r\n        }\r\n\r\n        console.log(`âœ… Finished syncing ${totalCount} products for ${payload.brandName}`);\r\n    }\r\n});\r\n"],
  "mappings": "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",
  "names": []
}
