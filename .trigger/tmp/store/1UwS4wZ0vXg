{
  "version": 3,
  "sources": ["../../../../../../../../src/trigger/test-translation-task.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\n\r\n// --- CONFIGURATION ---\r\nconst TARGET_LANGUAGES = [\r\n    { code: \"NL\", name: \"Dutch\" },\r\n    { code: \"DE\", name: \"German\" },\r\n    { code: \"FR\", name: \"French\" },\r\n    { code: \"IT\", name: \"Italian\" },\r\n    { code: \"ES\", name: \"Spanish\" },\r\n    { code: \"PT\", name: \"Portuguese\" },\r\n    { code: \"FI\", name: \"Finnish\" },\r\n    { code: \"ET\", name: \"Estonian\" },\r\n    { code: \"LV\", name: \"Latvian\" },\r\n    { code: \"LT\", name: \"Lithuanian\" },\r\n    { code: \"SK\", name: \"Slovak\" },\r\n    { code: \"SL\", name: \"Slovenian\" },\r\n    { code: \"EL\", name: \"Greek\" },\r\n    { code: \"HR\", name: \"Croatian\" },\r\n    { code: \"MT\", name: \"Maltese\" },\r\n];\r\n\r\nexport const testTranslationTask = task({\r\n    id: \"test-translation-task\",\r\n    run: async (payload: { productId: string }) => {\r\n        const { productId } = payload;\r\n        if (!productId) {\r\n            console.error(\"‚ùå No product ID provided.\");\r\n            return;\r\n        }\r\n\r\n        console.log(`üöÄ Starting TEST translation for product: ${productId}`);\r\n\r\n        const apiUrl = process.env.SALEOR_API_URL;\r\n        const geminiKey = process.env.GOOGLE_API_KEY;\r\n        let saleorToken = (process.env.SALEOR_APP_TOKEN || process.env.SALEOR_TOKEN || \"\").trim();\r\n\r\n        if (!apiUrl || !saleorToken || !geminiKey) {\r\n            throw new Error(\"Missing SALEOR_API_URL, SALEOR_TOKEN, or GOOGLE_API_KEY\");\r\n        }\r\n\r\n        saleorToken = `Bearer ${saleorToken.replace(/^bearer\\s+/i, \"\")}`;\r\n\r\n        const saleorFetch = async (query: string, variables: any = {}) => {\r\n            const res = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Authorization': saleorToken,\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({ query, variables })\r\n            });\r\n            return await res.json();\r\n        };\r\n\r\n        // 1. Fetch Product\r\n        const translationAliases = TARGET_LANGUAGES.map(lang => \r\n            `t_${lang.code}: translation(languageCode: ${lang.code}) { name description }`\r\n        ).join(\"\\n\");\r\n\r\n        console.log(\"üîç Fetching product data...\");\r\n\r\n        let productRes = await saleorFetch(`\r\n            query GetProduct($id: ID!) {\r\n                product(id: $id) {\r\n                    id\r\n                    name\r\n                    description\r\n                    ${translationAliases}\r\n                }\r\n            }\r\n        `, { id: productId });\r\n\r\n        let product = productRes.data?.product;\r\n\r\n        if (!product) {\r\n            console.warn(\"‚ö†Ô∏è product(id) returned null. Trying node(id)...\");\r\n            const nodeRes = await saleorFetch(`\r\n                query GetNode($id: ID!) {\r\n                    node(id: $id) {\r\n                        ... on Product {\r\n                            id\r\n                            name\r\n                            description\r\n                            ${translationAliases}\r\n                        }\r\n                    }\r\n                }\r\n            `, { id: productId });\r\n            product = nodeRes.data?.node;\r\n        }\r\n\r\n        if (!product) {\r\n            console.error(\"‚ùå Product NOT FOUND.\");\r\n            console.log(\"Response:\", JSON.stringify(productRes, null, 2));\r\n            return;\r\n        }\r\n\r\n        console.log(`‚úÖ Found Product: ${product.name} (${product.id})`);\r\n        console.log(`üìù Source Description: \"${product.description?.substring(0, 50)}...\"`);\r\n\r\n        // 2. Iterate Languages\r\n        for (const lang of TARGET_LANGUAGES) {\r\n            console.log(`\\n--- checking Language: ${lang.name} (${lang.code}) ---`);\r\n            \r\n            const existingTranslation = product[`t_${lang.code}`];\r\n            const sourceDesc = product.description || \"\";\r\n            const targetDesc = existingTranslation?.description || \"\";\r\n            const targetName = existingTranslation?.name || \"\";\r\n\r\n            console.log(`   Existing Translation: Name=\"${targetName}\", Desc=\"${targetDesc.substring(0, 30)}...\"`);\r\n\r\n            if (existingTranslation && existingTranslation.name && targetDesc && targetDesc !== sourceDesc) {\r\n                console.log(`   ‚è© SKIPPING: Valid translation already exists.`);\r\n                continue;\r\n            }\r\n\r\n            if (!targetDesc) console.log(\"   ‚û§ Reason to Translate: Description is missing.\");\r\n            else if (targetDesc === sourceDesc) console.log(\"   ‚û§ Reason to Translate: Description matches source (untranslated).\");\r\n            else console.log(\"   ‚û§ Reason to Translate: Name is missing.\");\r\n\r\n            console.log(`   ‚úçÔ∏è Translating to ${lang.name}...`);\r\n            \r\n            const translatedName = await translateText(product.name, lang.name, geminiKey, false, true); // Added debug flag\r\n            const translatedDescription = await translateText(product.description || \"\", lang.name, geminiKey, true, true);\r\n\r\n            console.log(`   ‚úÖ Gemini Result Name: \"${translatedName}\"`);\r\n            console.log(`   ‚úÖ Gemini Result Desc: \"${translatedDescription.substring(0, 30)}...\"`);\r\n\r\n            // 3. Update Saleor\r\n            console.log(\"   üíæ Saving to Saleor...\");\r\n            const updateRes = await saleorFetch(`\r\n                mutation UpdateTranslation($id: ID!, $language: LanguageCodeEnum!, $input: TranslationInput!) {\r\n                    productTranslate(id: $id, languageCode: $language, input: $input) {\r\n                        errors { field message }\r\n                    }\r\n                }\r\n            `, {\r\n                id: product.id,\r\n                language: lang.code,\r\n                input: { name: translatedName, description: translatedDescription }\r\n            });\r\n\r\n            if (updateRes.data?.productTranslate?.errors?.length > 0) {\r\n                console.error(`   ‚ùå Failed to update ${lang.name}:`, JSON.stringify(updateRes.data.productTranslate.errors, null, 2));\r\n            } else {\r\n                console.log(`   üéâ Automatically Saved!`);\r\n            }\r\n        }\r\n\r\n        console.log(\"\\nüèÅ Test Task Finished.\");\r\n    }\r\n});\r\n\r\nasync function translateText(text: string, targetLanguage: string, apiKey: string, isJson: boolean = false, debug: boolean = false): Promise<string> {\r\n    if (!text || text === \"{}\" || text === '{\"time\":0,\"blocks\":[],\"version\":\"2.25.0\"}') return text;\r\n\r\n    const prompt = isJson \r\n        ? `You are a professional e-commerce translator. Translate the following EditorJS JSON content into ${targetLanguage}. Keep the JSON structure identical, only translate the text values inside the blocks. Do not translate HTML tags or technical keys. Return ONLY the translated JSON.\\n\\nContent: ${text}`\r\n        : `Translate the following product name into ${targetLanguage}. If the name contains terms that are commonly used in ${targetLanguage} (like \"Snowboard\" in Dutch) or proper brand names, keep them in their original form. Return ONLY the final translated string.\\n\\nContent: ${text}`;\r\n\r\n    if (debug) console.log(`      [Gemini Request] Prompt: ${prompt.substring(0, 100)}...`);\r\n\r\n    try {\r\n        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${apiKey}`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                contents: [{ parts: [{ text: prompt }] }]\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errText = await response.text();\r\n            console.error(`      ‚ùå Gemini API Error (${response.status}):`, errText);\r\n            return text;\r\n        }\r\n\r\n        const data = await response.json();\r\n        // if (debug) console.log(`      [Gemini Response]:`, JSON.stringify(data));\r\n\r\n        const translatedContent = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();\r\n\r\n        if (!translatedContent) {\r\n            console.warn(`      ‚ö†Ô∏è Gemini returned empty translation for ${targetLanguage}.`);\r\n            return text;\r\n        }\r\n\r\n        return translatedContent.replace(/^```json\\n?/, '').replace(/\\n?```$/, '');\r\n    } catch (e) {\r\n        console.error(`      ‚ùå Translation error for ${targetLanguage}:`, e);\r\n        return text;\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;AAAA;AAGA,IAAM,mBAAmB;AAAA,EACrB,EAAE,MAAM,MAAM,MAAM,QAAQ;AAAA,EAC5B,EAAE,MAAM,MAAM,MAAM,SAAS;AAAA,EAC7B,EAAE,MAAM,MAAM,MAAM,SAAS;AAAA,EAC7B,EAAE,MAAM,MAAM,MAAM,UAAU;AAAA,EAC9B,EAAE,MAAM,MAAM,MAAM,UAAU;AAAA,EAC9B,EAAE,MAAM,MAAM,MAAM,aAAa;AAAA,EACjC,EAAE,MAAM,MAAM,MAAM,UAAU;AAAA,EAC9B,EAAE,MAAM,MAAM,MAAM,WAAW;AAAA,EAC/B,EAAE,MAAM,MAAM,MAAM,UAAU;AAAA,EAC9B,EAAE,MAAM,MAAM,MAAM,aAAa;AAAA,EACjC,EAAE,MAAM,MAAM,MAAM,SAAS;AAAA,EAC7B,EAAE,MAAM,MAAM,MAAM,YAAY;AAAA,EAChC,EAAE,MAAM,MAAM,MAAM,QAAQ;AAAA,EAC5B,EAAE,MAAM,MAAM,MAAM,WAAW;AAAA,EAC/B,EAAE,MAAM,MAAM,MAAM,UAAU;AAClC;AAEO,IAAM,sBAAsB,KAAK;AAAA,EACpC,IAAI;AAAA,EACJ,KAAK,8BAAO,YAAmC;AAC3C,UAAM,EAAE,UAAU,IAAI;AACtB,QAAI,CAAC,WAAW;AACZ,cAAQ,MAAM,2BAA2B;AACzC;AAAA,IACJ;AAEA,YAAQ,IAAI,6CAA6C,SAAS,EAAE;AAEpE,UAAM,SAAS,QAAQ,IAAI;AAC3B,UAAM,YAAY,QAAQ,IAAI;AAC9B,QAAI,eAAe,QAAQ,IAAI,oBAAoB,QAAQ,IAAI,gBAAgB,IAAI,KAAK;AAExF,QAAI,CAAC,UAAU,CAAC,eAAe,CAAC,WAAW;AACvC,YAAM,IAAI,MAAM,yDAAyD;AAAA,IAC7E;AAEA,kBAAc,UAAU,YAAY,QAAQ,eAAe,EAAE,CAAC;AAE9D,UAAM,cAAc,8BAAO,OAAe,YAAiB,CAAC,MAAM;AAC9D,YAAM,MAAM,MAAM,MAAM,QAAQ;AAAA,QAC5B,QAAQ;AAAA,QACR,SAAS;AAAA,UACL,iBAAiB;AAAA,UACjB,gBAAgB;AAAA,QACpB;AAAA,QACA,MAAM,KAAK,UAAU,EAAE,OAAO,UAAU,CAAC;AAAA,MAC7C,CAAC;AACD,aAAO,MAAM,IAAI,KAAK;AAAA,IAC1B,GAVoB;AAapB,UAAM,qBAAqB,iBAAiB;AAAA,MAAI,UAC5C,KAAK,KAAK,IAAI,+BAA+B,KAAK,IAAI;AAAA,IAC1D,EAAE,KAAK,IAAI;AAEX,YAAQ,IAAI,6BAA6B;AAEzC,QAAI,aAAa,MAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAMrB,kBAAkB;AAAA;AAAA;AAAA,WAG7B,EAAE,IAAI,UAAU,CAAC;AAEpB,QAAI,UAAU,WAAW,MAAM;AAE/B,QAAI,CAAC,SAAS;AACV,cAAQ,KAAK,kDAAkD;AAC/D,YAAM,UAAU,MAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAOhB,kBAAkB;AAAA;AAAA;AAAA;AAAA,eAIjC,EAAE,IAAI,UAAU,CAAC;AACpB,gBAAU,QAAQ,MAAM;AAAA,IAC5B;AAEA,QAAI,CAAC,SAAS;AACV,cAAQ,MAAM,sBAAsB;AACpC,cAAQ,IAAI,aAAa,KAAK,UAAU,YAAY,MAAM,CAAC,CAAC;AAC5D;AAAA,IACJ;AAEA,YAAQ,IAAI,oBAAoB,QAAQ,IAAI,KAAK,QAAQ,EAAE,GAAG;AAC9D,YAAQ,IAAI,2BAA2B,QAAQ,aAAa,UAAU,GAAG,EAAE,CAAC,MAAM;AAGlF,eAAW,QAAQ,kBAAkB;AACjC,cAAQ,IAAI;AAAA,yBAA4B,KAAK,IAAI,KAAK,KAAK,IAAI,OAAO;AAEtE,YAAM,sBAAsB,QAAQ,KAAK,KAAK,IAAI,EAAE;AACpD,YAAM,aAAa,QAAQ,eAAe;AAC1C,YAAM,aAAa,qBAAqB,eAAe;AACvD,YAAM,aAAa,qBAAqB,QAAQ;AAEhD,cAAQ,IAAI,kCAAkC,UAAU,YAAY,WAAW,UAAU,GAAG,EAAE,CAAC,MAAM;AAErG,UAAI,uBAAuB,oBAAoB,QAAQ,cAAc,eAAe,YAAY;AAC5F,gBAAQ,IAAI,kDAAkD;AAC9D;AAAA,MACJ;AAEA,UAAI,CAAC,WAAY,SAAQ,IAAI,mDAAmD;AAAA,eACvE,eAAe,WAAY,SAAQ,IAAI,sEAAsE;AAAA,UACjH,SAAQ,IAAI,4CAA4C;AAE7D,cAAQ,IAAI,wBAAwB,KAAK,IAAI,KAAK;AAElD,YAAM,iBAAiB,MAAM,cAAc,QAAQ,MAAM,KAAK,MAAM,WAAW,OAAO,IAAI;AAC1F,YAAM,wBAAwB,MAAM,cAAc,QAAQ,eAAe,IAAI,KAAK,MAAM,WAAW,MAAM,IAAI;AAE7G,cAAQ,IAAI,6BAA6B,cAAc,GAAG;AAC1D,cAAQ,IAAI,6BAA6B,sBAAsB,UAAU,GAAG,EAAE,CAAC,MAAM;AAGrF,cAAQ,IAAI,2BAA2B;AACvC,YAAM,YAAY,MAAM,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAMjC;AAAA,QACC,IAAI,QAAQ;AAAA,QACZ,UAAU,KAAK;AAAA,QACf,OAAO,EAAE,MAAM,gBAAgB,aAAa,sBAAsB;AAAA,MACtE,CAAC;AAED,UAAI,UAAU,MAAM,kBAAkB,QAAQ,SAAS,GAAG;AACtD,gBAAQ,MAAM,yBAAyB,KAAK,IAAI,KAAK,KAAK,UAAU,UAAU,KAAK,iBAAiB,QAAQ,MAAM,CAAC,CAAC;AAAA,MACxH,OAAO;AACH,gBAAQ,IAAI,4BAA4B;AAAA,MAC5C;AAAA,IACJ;AAEA,YAAQ,IAAI,0BAA0B;AAAA,EAC1C,GA/HK;AAgIT,CAAC;AAED,eAAe,cAAc,MAAc,gBAAwB,QAAgB,SAAkB,OAAO,QAAiB,OAAwB;AACjJ,MAAI,CAAC,QAAQ,SAAS,QAAQ,SAAS,4CAA6C,QAAO;AAE3F,QAAM,SAAS,SACT,oGAAoG,cAAc;AAAA;AAAA,WAAqL,IAAI,KAC3S,6CAA6C,cAAc,0DAA0D,cAAc;AAAA;AAAA,WAA8I,IAAI;AAE3R,MAAI,MAAO,SAAQ,IAAI,kCAAkC,OAAO,UAAU,GAAG,GAAG,CAAC,KAAK;AAEtF,MAAI;AACA,UAAM,WAAW,MAAM,MAAM,qGAAqG,MAAM,IAAI;AAAA,MACxI,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU;AAAA,QACjB,UAAU,CAAC,EAAE,OAAO,CAAC,EAAE,MAAM,OAAO,CAAC,EAAE,CAAC;AAAA,MAC5C,CAAC;AAAA,IACL,CAAC;AAED,QAAI,CAAC,SAAS,IAAI;AACd,YAAM,UAAU,MAAM,SAAS,KAAK;AACpC,cAAQ,MAAM,6BAA6B,SAAS,MAAM,MAAM,OAAO;AACvE,aAAO;AAAA,IACX;AAEA,UAAM,OAAO,MAAM,SAAS,KAAK;AAGjC,UAAM,oBAAoB,KAAK,aAAa,CAAC,GAAG,SAAS,QAAQ,CAAC,GAAG,MAAM,KAAK;AAEhF,QAAI,CAAC,mBAAmB;AACpB,cAAQ,KAAK,kDAAkD,cAAc,GAAG;AAChF,aAAO;AAAA,IACX;AAEA,WAAO,kBAAkB,QAAQ,eAAe,EAAE,EAAE,QAAQ,WAAW,EAAE;AAAA,EAC7E,SAAS,GAAG;AACR,YAAQ,MAAM,iCAAiC,cAAc,KAAK,CAAC;AACnE,WAAO;AAAA,EACX;AACJ;AAvCe;",
  "names": []
}
